<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>core/extend/buddypress/buddypress.php - wp-flawless</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="http://a3d72a45d111006ec192-ec5b80a12b0b09b4d52373336afb4254.r80.cf1.rackcdn.com/usability-dynamics.png" title="wp-flawless"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.1.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/API.html">API</a></li>
            
                <li><a href="../classes/Carrington.html">Carrington</a></li>
            
                <li><a href="../classes/Extended_Taxonomies.html">Extended_Taxonomies</a></li>
            
                <li><a href="../classes/Flawless.API.html">Flawless.API</a></li>
            
                <li><a href="../classes/Flawless.Asset.html">Flawless.Asset</a></li>
            
                <li><a href="../classes/Flawless.Branded_Login.html">Flawless.Branded_Login</a></li>
            
                <li><a href="../classes/Flawless.BuddyPress.html">Flawless.BuddyPress</a></li>
            
                <li><a href="../classes/Flawless.Content.html">Flawless.Content</a></li>
            
                <li><a href="../classes/Flawless.Element.html">Flawless.Element</a></li>
            
                <li><a href="../classes/Flawless.Flawless\Shortcode.html">Flawless.Flawless\Shortcode</a></li>
            
                <li><a href="../classes/Flawless.Management.html">Flawless.Management</a></li>
            
                <li><a href="../classes/Flawless.Mobile.html">Flawless.Mobile</a></li>
            
                <li><a href="../classes/Flawless.Navbars.html">Flawless.Navbars</a></li>
            
                <li><a href="../classes/Flawless.Schema.html">Flawless.Schema</a></li>
            
                <li><a href="../classes/Flawless.Settings.html">Flawless.Settings</a></li>
            
                <li><a href="../classes/Flawless.Styles.html">Flawless.Styles</a></li>
            
                <li><a href="../classes/Flawless.Utility.html">Flawless.Utility</a></li>
            
                <li><a href="../classes/Flawless.Widget.html">Flawless.Widget</a></li>
            
                <li><a href="../classes/flawless_wpp_extensions.html">flawless_wpp_extensions</a></li>
            
                <li><a href="../classes/Legacy.html">Legacy</a></li>
            
                <li><a href="../classes/License.html">License</a></li>
            
                <li><a href="../classes/Loader.html">Loader</a></li>
            
                <li><a href="../classes/Log.html">Log</a></li>
            
                <li><a href="../classes/Maintenance.html">Maintenance</a></li>
            
                <li><a href="../classes/Models.html">Models</a></li>
            
                <li><a href="../classes/Module.html">Module</a></li>
            
                <li><a href="../classes/Multisite.html">Multisite</a></li>
            
                <li><a href="../classes/SaaS.html">SaaS</a></li>
            
                <li><a href="../classes/Shortcode.html">Shortcode</a></li>
            
                <li><a href="../classes/Shortcodes.html">Shortcodes</a></li>
            
                <li><a href="../classes/Template Methods.html">Template Methods</a></li>
            
                <li><a href="../classes/Theme.html">Theme</a></li>
            
                <li><a href="../classes/UI.html">UI</a></li>
            
                <li><a href="../classes/Utility.html">Utility</a></li>
            
                <li><a href="../classes/Views.html">Views</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/API.html">API</a></li>
            
                <li><a href="../modules/Branded Login.html">Branded Login</a></li>
            
                <li><a href="../modules/Carrington.html">Carrington</a></li>
            
                <li><a href="../modules/Carrington Build.html">Carrington Build</a></li>
            
                <li><a href="../modules/carrington-build.html">carrington-build</a></li>
            
                <li><a href="../modules/cfct_build.html">cfct_build</a></li>
            
                <li><a href="../modules/default.html">default</a></li>
            
                <li><a href="../modules/Flawless.html">Flawless</a></li>
            
                <li><a href="../modules/Loader.html">Loader</a></li>
            
                <li><a href="../modules/Log.html">Log</a></li>
            
                <li><a href="../modules/Maintenence.html">Maintenence</a></li>
            
                <li><a href="../modules/Management.html">Management</a></li>
            
                <li><a href="../modules/Multisite.html">Multisite</a></li>
            
                <li><a href="../modules/SaaS.html">SaaS</a></li>
            
                <li><a href="../modules/Services_JSON.html">Services_JSON</a></li>
            
                <li><a href="../modules/Shortcodes.html">Shortcodes</a></li>
            
                <li><a href="../modules/taxonomy-landing

This file is part of Taxonomy Landing for WordPress
http:__github.com_crowdfavorite_wp-taxonomy-landing

Copyright (c) 2009-2012 Crowd Favorite, Ltd. All rights reserved.
http:__crowdfavorite.com

Released under the GPL license
http:__www.opensource.org_licenses_gpl-license.php

**********************************************************************
This program is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
**********************************************************************.html">taxonomy-landing

This file is part of Taxonomy Landing for WordPress
http://github.com/crowdfavorite/wp-taxonomy-landing

Copyright (c) 2009-2012 Crowd Favorite, Ltd. All rights reserved.
http://crowdfavorite.com

Released under the GPL license
http://www.opensource.org/licenses/gpl-license.php

**********************************************************************
This program is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
**********************************************************************</a></li>
            
                <li><a href="../modules/taxonomy-landing

This file is part of Taxonomy Landing for WordPress
https:__github.com_crowdfavorite_wp-taxonomy-landing

Copyright (c) 2009-2012 Crowd Favorite, Ltd. All rights reserved.
http:__crowdfavorite.com

**********************************************************************
This program is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
**********************************************************************.html">taxonomy-landing

This file is part of Taxonomy Landing for WordPress
https://github.com/crowdfavorite/wp-taxonomy-landing

Copyright (c) 2009-2012 Crowd Favorite, Ltd. All rights reserved.
http://crowdfavorite.com

**********************************************************************
This program is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
**********************************************************************</a></li>
            
                <li><a href="../modules/Theme UI.html">Theme UI</a></li>
            
                <li><a href="../modules/UI.html">UI</a></li>
            
                <li><a href="../modules/UsabilityDynamics.html">UsabilityDynamics</a></li>
            
                <li><a href="../modules/Utility.html">Utility</a></li>
            
                <li><a href="../modules/Views.html">Views</a></li>
            
                <li><a href="../modules/WP-Property.html">WP-Property</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: core/extend/buddypress/buddypress.php</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&lt;?php
/**
 * Name: BuddyPress Extensions
 * Version: 1.0
 * Description: Extra functionality for the BuddyPress plugin
 * Author: Usability Dynamics, Inc.
 *
 */
namespace Flawless {

  /**
   * Class BuddyPress
   *
   * @class BuddyPress
   * @module Flawless
   */
  class BuddyPress {

    /**
     * Returns false. Used for add_filter() and remove_filter()
     *
     * @author potanin@UD
     */
    static function return_false() {
      return false;
    }

    /**
     * Returns true.  Used for add_filter() and remove_filter()
     *
     * @author potanin@UD
     */
    static function return_true() {
      return true;
    }

    /**
     * Force Flawless template_redirect to be loaded in BuddyPress
     *
     * @author potanin@UD
     */
    function Flawless_setup( $located_template ) {
      global $bp, $flawless;

      if ( !is_object( $bp ) ) {
        return;
      }

      add_theme_support( &#x27;bbpress&#x27; );

      add_filter( &#x27;bp_get_the_topic_post_content&#x27;, array( &#x27;flawless_shortcodes&#x27;, &#x27;do_code_shortcode&#x27; ), 0 );
      add_filter( &#x27;bp_get_the_topic_post_content&#x27;, array( &#x27;flawless_shortcodes&#x27;, &#x27;do_code_shortcode&#x27; ), 100 );

      //** TEMPORARY SETTINGS */
      $flawless[ &#x27;buddypress&#x27; ][ &#x27;hide_group_search&#x27; ] = &#x27;true&#x27;;
      $flawless[ &#x27;buddypress&#x27; ][ &#x27;hide_top_pagination&#x27; ] = &#x27;true&#x27;;
      $flawless[ &#x27;buddypress&#x27; ][ &#x27;hide_group_admins&#x27; ] = &#x27;true&#x27;;
      $flawless[ &#x27;buddypress&#x27; ][ &#x27;navbar&#x27; ][ &#x27;hide_dashboard&#x27; ] = &#x27;true&#x27;;
      $flawless[ &#x27;buddypress&#x27; ][ &#x27;navbar&#x27; ][ &#x27;hide_random&#x27; ] = &#x27;true&#x27;;

      //** Add shortcodes */
      add_shortcode( &#x27;buddy_press_groups&#x27;, array( &#x27;Flawless_BuddyPress&#x27;, &#x27;buddy_press_groups&#x27; ) );
      add_shortcode( &#x27;group_description&#x27;, array( &#x27;Flawless_BuddyPress&#x27;, &#x27;group_description&#x27; ) );
      add_shortcode( &#x27;group_meta&#x27;, array( &#x27;Flawless_BuddyPress&#x27;, &#x27;group_meta&#x27; ) );
      add_shortcode( &#x27;bp_registration_form&#x27;, array( &#x27;Flawless_BuddyPress&#x27;, &#x27;bp_registration_form&#x27; ) );

      add_action( &#x27;init&#x27;, array( &#x27;Flawless_BuddyPress&#x27;, &#x27;init&#x27; ) );

      add_action( &#x27;flawless::navbar_options&#x27;, array( &#x27;Flawless_BuddyPress&#x27;, &#x27;navbar_options&#x27; ) );
      add_action( &#x27;flawless::use_navbar&#x27;, array( &#x27;Flawless_BuddyPress&#x27;, &#x27;use_navbar&#x27; ) );

      add_action( &#x27;admin_init&#x27;, array( &#x27;Flawless_BuddyPress&#x27;, &#x27;admin_init&#x27; ), 0 );

      //** Stop the Admin Bar from being rendered by BuddyPress */
      remove_action( &#x27;bp_init&#x27;, &#x27;bp_core_load_buddybar_css&#x27; );
      remove_action( &#x27;wp_footer&#x27;, &#x27;bp_core_admin_bar&#x27;, 8 );
      remove_action( &#x27;admin_footer&#x27;, &#x27;bp_core_admin_bar&#x27; );

      /** Determine if BP Template Pack is used */
      self::check_for_bp_template_pack();

      $params = array(
        &#x27;my_favs&#x27; =&gt; __( &#x27;My Favorites&#x27;, &#x27;buddypress&#x27; ),
        &#x27;accepted&#x27; =&gt; __( &#x27;Accepted&#x27;, &#x27;buddypress&#x27; ),
        &#x27;rejected&#x27; =&gt; __( &#x27;Rejected&#x27;, &#x27;buddypress&#x27; ),
        &#x27;show_all_comments&#x27; =&gt; __( &#x27;Show all comments for this thread&#x27;, &#x27;buddypress&#x27; ),
        &#x27;show_all&#x27; =&gt; __( &#x27;Show all&#x27;, &#x27;buddypress&#x27; ),
        &#x27;comments&#x27; =&gt; __( &#x27;comments&#x27;, &#x27;buddypress&#x27; ),
        &#x27;close&#x27; =&gt; __( &#x27;Close&#x27;, &#x27;buddypress&#x27; ),
        &#x27;view&#x27; =&gt; __( &#x27;View&#x27;, &#x27;buddypress&#x27; )
      );

      wp_localize_script( &#x27;flawless-asset-buddypress&#x27;, &#x27;BP_DTheme&#x27;, $params );

      add_filter( &#x27;body_class&#x27;, array( &#x27;Flawless_BuddyPress&#x27;, &#x27;body_class&#x27; ) );

      add_action( &#x27;bp_is_current_component&#x27;, array( &#x27;Flawless_BuddyPress&#x27;, &#x27;bp_is_current_component&#x27; ), 2, 10 );
      add_filter( &#x27;flawless_request_type&#x27;, array( &#x27;Flawless_BuddyPress&#x27;, &#x27;flawless_request_type&#x27; ) );
      add_filter( &#x27;set_current_view&#x27;, array( &#x27;Flawless_BuddyPress&#x27;, &#x27;set_current_view&#x27; ) );
      add_filter( &#x27;bp_load_template&#x27;, array( &#x27;Flawless_BuddyPress&#x27;, &#x27;bp_load_template&#x27; ) );

      add_filter( &#x27;widgets_init&#x27;, array( &#x27;Flawless_BuddyPress&#x27;, &#x27;widgets_init&#x27; ) );

      add_filter( &#x27;bp_get_groups_pagination_count&#x27;, array( &#x27;Flawless_BuddyPress&#x27;, &#x27;render_pagination_count&#x27; ), 10 );
      add_filter( &#x27;bp_get_groups_pagination_links&#x27;, array( &#x27;Flawless_BuddyPress&#x27;, &#x27;render_pagination_links&#x27; ), 10 );

      //** XProfile filters */
      add_filter( &#x27;xprofile_filter_profile_group_tabs&#x27;, array( &#x27;Flawless_BuddyPress&#x27;, &#x27;profile_group_tabs&#x27; ), 10, 3 );

      add_filter( &#x27;bp_forum_topic_tag_list&#x27;, array( &#x27;Flawless_BuddyPress&#x27;, &#x27;bp_forum_topic_tag_list&#x27; ), 10, 2 );

      add_filter( &#x27;flawless::primary_notice_container&#x27;, array( &#x27;Flawless_BuddyPress&#x27;, &#x27;primary_notice_container&#x27; ), 10 );

      add_filter( &#x27;flawless::my_account_url&#x27;, array( &#x27;Flawless_BuddyPress&#x27;, &#x27;my_account_url&#x27; ), 10 );

    }

    /**
     * Primary handler.
     *
     * @author potanin@UD
     */
    function init() {
      global $bp, $flawless;

      add_action( &#x27;wp_ajax_bp_get_topics&#x27;, create_function( &#x27;&#x27;, &#x27; die(Flawless_BuddyPress::get_json_topics()); &#x27; ) );
      add_action( &#x27;wp_ajax_nopriv_bp_get_topics&#x27;, create_function( &#x27;&#x27;, &#x27; die(Flawless_BuddyPress::get_json_topics()); &#x27; ) );

      /*  Add BuddyPress forum topics to  Google XML Sitemaps */
      add_action( &#x27;sm_buildmap&#x27;, array( &#x27;Flawless_BuddyPress&#x27;, &#x27;sm_buildmap&#x27; ) );

      /* Automate redirection from /group/home to /group/ */
      add_action( &#x27;groups_screen_group_home&#x27;, array( &#x27;Flawless_BuddyPress&#x27;, &#x27;groups_screen_group_home&#x27; ) );

      add_action( &#x27;groups_custom_group_fields_editable&#x27;, array( &#x27;Flawless_BuddyPress&#x27;, &#x27;groups_custom_group_fields_editable&#x27; ) );
      add_action( &#x27;groups_group_details_edited&#x27;, array( &#x27;Flawless_BuddyPress&#x27;, &#x27;groups_group_details_edited&#x27; ) );

      /** Theme Settings */
      add_action( &#x27;flawless_options_ui_main&#x27;, array( &#x27;Flawless_BuddyPress&#x27;, &#x27;flawless_options_ui_main&#x27; ), 100 );

    }

    /**
     * Add option to edited page to use original content instead of BP override
     *
     * Only applied to &quot;Root&quot; BuddyPress pages such as Activity Streams, Discussion Forums, etc.
     * Child pages, such as /groups/some-group automatically override BP-generated pages when they exist.
     *
     * @author potanin@UD
     */
    function admin_init( $t ) {
      global $bp, $post, $wpdb;

      if ( $_GET[ &#x27;post&#x27; ] ) {
        $post_id = $_GET[ &#x27;post&#x27; ];
      } else {
        return;
      }

      if ( !in_array( $post_id, (array)bp_core_get_directory_page_ids() ) ) {
        return;
      }

      Flawless::add_post_type_option( array(
        &#x27;post_type&#x27; =&gt; $wpdb-&gt;get_var( &quot;SELECT post_type FROM {$wpdb-&gt;posts} WHERE ID = $post_id&quot; ),
        &#x27;position&#x27; =&gt; 1000,
        &#x27;meta_key&#x27; =&gt; &#x27;override_buddypress_template&#x27;,
        &#x27;label&#x27; =&gt; sprintf( __( &#x27;Do not load BuddyPress content.&#x27;, &#x27;flawless&#x27; ) )
      ) );

    }

    /**
     * Add Theme Settings
     *
     * @author potanin@UD
     */
    function flawless_options_ui_main( $flawless ) {
      ?&gt;

      &lt;tr valign=&quot;top&quot;&gt;
        &lt;th&gt;&lt;?php _e( &#x27;BuddyPress&#x27;, &#x27;flawless&#x27; ); ?&gt;&lt;/th&gt;
        &lt;td&gt;
          &lt;ul&gt;
            &lt;li&gt;
              &lt;label&gt;
                &lt;?php _e( &#x27;Forum sidebar:&#x27;, &#x27;flawless&#x27; ); ?&gt;
                &lt;select name=&quot;flawless_settings[buddypress][forum_sidebar]&quot; class=&quot;flawless_live_data_target&quot;
                        flawless_live_data_target=&quot;widget_areas&quot;/&gt;
                &lt;option value=&quot;&quot;&gt;&lt;/option&gt;
                &lt;?php foreach ( (array)$flawless[ &#x27;widget_areas&#x27; ][ &#x27;all&#x27; ] as $sidebar_id =&gt; $sidebar_data ) { ?&gt;
                  &lt;option
                    value=&quot;&lt;?php echo $sidebar_id; ?&gt;&quot; &lt;?php echo selected( $sidebar_id, $flawless[ &#x27;buddypress&#x27; ][ &#x27;forum_sidebar&#x27; ] ); ?&gt;  &gt;&lt;?php echo $sidebar_data[ &#x27;name&#x27; ]; ?&gt;&lt;/option&gt;
                &lt;?php } ?&gt;
                &lt;/select&gt;
              &lt;/label&gt;
            &lt;/li&gt;
          &lt;/ul&gt;
        &lt;/td&gt;
      &lt;/tr&gt;

    &lt;?php
    }

    /**
     * Automatically redirects /group/home to /group/
     *
     * @todo Bugs out. - potanin@UD
     * @action groups_screen_group_home (1)
     * @author UsabilityDynamics.com
     */
    function groups_screen_group_home() {
      global $bp;

      if ( isset( $_GET[ &#x27;n&#x27; ] ) || empty( $bp-&gt;groups-&gt;current_group ) ) {
        return;
      }

      /** Split up the current request */
      $segments = spliti( &#x27;/&#x27;, trim( $_SERVER[ &#x27;REQUEST_URI&#x27; ], &#x27;/&#x27; ) );
      $last_segment = array_pop( $segments );

      $redirect = false;

      /** If we&#x27;re on the home page, redirect */
      if ( $last_segment == &quot;home&quot; ) $redirect = true;

      /** If we&#x27;re on the members page, and we are hiding the member list */
      $hide_member_list = groups_get_groupmeta( $bp-&gt;groups-&gt;current_group-&gt;id, &#x27;hide_member_list&#x27; );
      if ( $last_segment == &quot;members&quot; &amp;&amp; $hide_member_list == &#x27;true&#x27; ) $redirect = true;

      /** Redirect if we need */
      if ( $redirect ) die( wp_redirect( bp_get_group_permalink( $bp-&gt;groups-&gt;current_group ) ) );

    }

    /**
     * Save extra group attributes, fired off only on group update only.
     *
     * @action groups_group_details_edited
     * @author UsabilityDynamics.com
     */
    function groups_group_details_edited( $group_id = false ) {

      if ( !$group_id ) {
        return;
      }

      foreach ( ( array )$_REQUEST[ &#x27;bp_group_data&#x27; ] as $meta_key =&gt; $meta_value ) {
        groups_update_groupmeta( $group_id, $meta_key, $meta_value );
      }

    }

    /**
     * Add extra configuration options to Group Editing page.
     *
     * @author potanin@UD
     */
    function groups_custom_group_fields_editable( $t ) {
      global $bp, $groups_template, $wp_registered_sidebars;

      /* Don&#x27;t display this on new group creation, only on saved groups */
      if ( !$groups_template ) {
        return;
      }

      ?&gt;

      &lt;input type=&quot;hidden&quot; name=&quot;bp_group_data[hide_header]&quot; value=&quot;&quot;&gt;
      &lt;input type=&quot;hidden&quot; name=&quot;bp_group_data[hide_navigation]&quot; value=&quot;&quot;&gt;
      &lt;input type=&quot;hidden&quot; name=&quot;bp_group_data[hide_member_list]&quot; value=&quot;&quot;&gt;


      &lt;div class=&quot;control-group&quot;&gt;
        &lt;label class=&quot;control-label&quot;&gt;&lt;?php _e( &#x27;Forum &amp; Topics&#x27;, &#x27;flawless&#x27; ) ?&gt;&lt;/label&gt;

        &lt;div class=&quot;controls&quot;&gt;
          &lt;textarea name=&quot;ud_data[new_topic_entry_intro]&quot;
                    class=&quot;span7&quot;&gt;&lt;?php echo stripslashes( groups_get_groupmeta( $bp-&gt;groups-&gt;current_group-&gt;id, &#x27;new_topic_entry_intro&#x27; ) ); ?&gt;&lt;/textarea&gt;

          &lt;p
            class=&quot;help-block&quot;&gt;&lt;?php _e( &#x27;New Topic Entry intro text, displayed above the text area.&#x27;, &#x27;flawless&#x27; ) ?&gt;&lt;/p&gt;
        &lt;/div&gt;

        &lt;div class=&quot;controls&quot;&gt;
          &lt;textarea name=&quot;ud_data[new_topic_entry_help]&quot;
                    class=&quot;span7&quot;&gt;&lt;?php echo stripslashes( groups_get_groupmeta( $bp-&gt;groups-&gt;current_group-&gt;id, &#x27;new_topic_entry_help&#x27; ) ); ?&gt;&lt;/textarea&gt;

          &lt;p class=&quot;help-block&quot;&gt;&lt;?php _e( &#x27;New Topic Entry help text, displayed below the textarea.&#x27;, &#x27;flawless&#x27; ) ?&gt;&lt;/p&gt;
        &lt;/div&gt;

      &lt;/div&gt;

      &lt;div class=&quot;control-group&quot;&gt;
        &lt;label class=&quot;control-label&quot;&gt;&lt;?php _e( &#x27;Display Settings&#x27;, &#x27;flawless&#x27; ) ?&gt;&lt;/label&gt;

        &lt;div class=&quot;controls&quot;&gt;
          &lt;label class=&quot;checkbox&quot;&gt;
            &lt;input type=&quot;checkbox&quot; name=&quot;bp_group_data[hide_header]&quot;
                   value=&quot;true&quot; &lt;?php checked( groups_get_groupmeta( $bp-&gt;groups-&gt;current_group-&gt;id, &#x27;hide_header&#x27; ), &#x27;true&#x27; ); ?&gt;&gt; &lt;?php _e( &#x27;Hide header.&#x27;, &#x27;flawless&#x27; ); ?&gt;
          &lt;/label&gt;
          &lt;label class=&quot;checkbox&quot;&gt;
            &lt;input type=&quot;checkbox&quot; name=&quot;bp_group_data[hide_navigation]&quot;
                   value=&quot;true&quot; &lt;?php checked( groups_get_groupmeta( $bp-&gt;groups-&gt;current_group-&gt;id, &#x27;hide_navigation&#x27; ), &#x27;true&#x27; ); ?&gt;&gt; &lt;?php _e( &#x27;Hide navigation.&#x27;, &#x27;flawless&#x27; ); ?&gt;
          &lt;/label&gt;
          &lt;label class=&quot;checkbox&quot;&gt;
            &lt;input type=&quot;checkbox&quot; name=&quot;bp_group_data[hide_member_list]&quot;
                   value=&quot;true&quot; &lt;?php checked( groups_get_groupmeta( $bp-&gt;groups-&gt;current_group-&gt;id, &#x27;hide_member_list&#x27; ), &#x27;true&#x27; ); ?&gt;&gt; &lt;?php _e( &#x27;Hide member list.&#x27;, &#x27;flawless&#x27; ); ?&gt;
          &lt;/label&gt;
        &lt;/div&gt;
      &lt;/div&gt;

      &lt;div class=&quot;control-group&quot;&gt;
        &lt;label class=&quot;control-label&quot;&gt;&lt;?php _e( &#x27;Right Sidebar&#x27;, &#x27;flawless&#x27; ) ?&gt;&lt;/label&gt;

        &lt;div class=&quot;controls&quot;&gt;
          &lt;select name=&quot;bp_group_data[right_sidebar]&quot;&gt;
            &lt;option value=&quot;&quot;&gt;
              &lt;?php foreach ((array)$wp_registered_sidebars as $sidebar_id =&gt; $sidebar_data) { ?&gt;
            &lt;option &lt;?php selected( groups_get_groupmeta( $bp-&gt;groups-&gt;current_group-&gt;id, &#x27;right_sidebar&#x27; ), $sidebar_id ); ?&gt;
              value=&quot;&lt;?php echo $sidebar_id; ?&gt;&quot;&gt;&lt;?php echo $sidebar_data[ &#x27;name&#x27; ]; ?&gt;&lt;/option&gt;
            &lt;?php } ?&gt;
          &lt;/select&gt;
        &lt;/div&gt;
      &lt;/div&gt;

    &lt;?php
    }

    /**
     * Make BuddyPress be recognized as a seprate view
     *
     * @author potanin@UD
     */
    function flawless_request_type( $t ) {
      global $bp, $post;

      if ( empty( $bp-&gt;current_component ) || ( get_post_meta( $post-&gt;ID, &#x27;override_buddypress_template&#x27;, true ) == &#x27;true&#x27; &amp;&amp; $bp-&gt;current_action == &#x27;home&#x27; ) || $bp-&gt;use_default_page ) {
        return $t;
      }

      $t[ &#x27;group&#x27; ] = &#x27;buddy_press&#x27;;
      $t[ &#x27;type&#x27; ] = $bp-&gt;current_component;
      $t[ &#x27;view&#x27; ] = $bp-&gt;current_action;

      Flawless::console_log( &#x27;P: Current View: Unknown - rendering same as Page.&#x27; );

      return $t;

    }

    /**
     * Make BuddyPress be recognized as a seprate view
     *
     *
     * @todo This could be improved - if a Right sidebar is enabled for a group, then the function stops without checking for other sidebars - potanin@UD
     * @todo get_post_meta( $post-&gt;ID, &#x27;override_buddypress_template&#x27;, true ) kicks in for non-primary pages as well, while it should be ignored on secondary pages (such as /forum/ ) - potanin@UD
     * @author potanin@UD
     */
    function set_current_view( $view ) {
      global $bp, $post, $wp_query, $flawless;

      //** If this is a &quot;home&quot; action and override enabled, we do nothing */
      if ( empty( $bp-&gt;current_component ) || ( get_post_meta( $post-&gt;ID, &#x27;override_buddypress_template&#x27;, true ) == &#x27;true&#x27; &amp;&amp; $bp-&gt;current_action == &#x27;home&#x27; ) || $bp-&gt;use_default_page ) {
        return $view;
      }

      if ( $right_sidebar = groups_get_groupmeta( $bp-&gt;groups-&gt;current_group-&gt;id, &#x27;right_sidebar&#x27; ) ) {

        if ( $key = array_search( &#x27;no-sidebars&#x27;, $view[ &#x27;body_classes&#x27; ] ) ) {
          unset( $view[ &#x27;body_classes&#x27; ][ $key ] );
        }

        if ( $key = array_search( &#x27;no-sidebar-right&#x27;, $view[ &#x27;body_classes&#x27; ] ) ) {
          unset( $view[ &#x27;body_classes&#x27; ][ $key ] );
        }

        $view[ &#x27;body_classes&#x27; ][ ] = &#x27;have-sidebar&#x27;;
        $view[ &#x27;body_classes&#x27; ][ ] = &#x27;sidebar-right&#x27;;

        $view[ &#x27;widget_areas&#x27; ][ &#x27;right_sidebar&#x27; ][ ] = $right_sidebar;

        return $view;

      }

      //** Remove sidebars if they are there */
      unset( $view[ &#x27;widget_areas&#x27; ] );

      /**
       * I guess we don&#x27;t need to fully override body_classes, because it can contain some necessary classes.
       * So just remove sidebar classes and set them again.
       * peshkov@UD
       */
      $view[ &#x27;body_classes&#x27; ] = (array)$view[ &#x27;body_classes&#x27; ];

      foreach ( $view[ &#x27;body_classes&#x27; ] as $key =&gt; $class ) {
        if ( strpos( $class, &#x27;sidebar&#x27; ) !== false ) {
          unset( $view[ &#x27;body_classes&#x27; ][ $key ] );
        }
      }

      //** Unset to go full width */
      $view[ &#x27;body_classes&#x27; ][ ] = &#x27;no-sidebar-left&#x27;;
      if ( !is_active_sidebar( &#x27;buddypress_sidebar&#x27; ) ) {
        $view[ &#x27;body_classes&#x27; ][ ] = &#x27;no-sidebars&#x27;;

      } else {
        $view[ &#x27;body_classes&#x27; ][ ] = &#x27;have-sidebar&#x27;;
        $view[ &#x27;body_classes&#x27; ][ ] = &#x27;sidebar-right&#x27;;
      }

      return $view;

    }

    /**
     * Change the &quot;My URL&quot; URLs to the BuddyPress Profile
     *
     * @author potanin@UD
     */
    function my_account_url() {
      global $bp;

      return $bp-&gt;loggedin_user-&gt;domain;

    }

    /**
     * Add HTML to tag lists
     *
     * @author potanin@UD
     */
    function bp_forum_topic_tag_list( $tags, $format ) {

      $html = array();

      foreach ( (array)$tags as $tag ) {
        $html[ ] = &#x27;&lt;span class=&quot;btn&quot;&gt;&#x27; . $tag . &#x27;&lt;/span&gt;&#x27;;
      }

      return implode( &#x27;&#x27;, (array)$html );

    }

    /**
     * Display BuddyPress notices in standard notice location
     *
     * @author potanin@UD
     */
    function primary_notice_container( $notices ) {

      ob_start();
      do_action( &#x27;template_notices&#x27; );
      $content = ob_get_contents();
      ob_end_clean();

      if ( empty( $content ) ) {
        return $notices;
      }

      $notices[ ] = &#x27;&lt;div class=&quot;alert fade in&quot;&gt;&lt;a class=&quot;close&quot; data-dismiss=&quot;alert&quot; href=&quot;#&quot;&gt;&amp;times;&lt;/a&gt;&#x27; . $content . &#x27;&lt;/div&gt;&#x27;;

      return $notices;

    }

    /**
     * Render pagination links and wrapper if they exist
     *
     *
     * @todo Test with multiple pages of groups, developed to solve the one-page view for all groups.
     * @author potanin@UD
     */
    function render_pagination_links( $text ) {

      if ( empty( $text ) ) {
        return false;
      }

      $html[ ] = &#x27;&lt;div class=&quot;pagination-links&quot;&gt;&#x27;;
      $html[ ] = $text;
      $html[ ] = &#x27;&lt;/div&gt;&#x27;;

      return implode( &#x27;&#x27;, (array)$html );

    }

    /**
     * Fix the pagination display
     *
     *
     * @todo Test with multiple pages of groups, developed to solve the one-page view for all groups.
     * @author potanin@UD
     */
    function render_pagination_count( $text ) {
      global $groups_template;

      if ( $groups_template ) {
        $component = &#x27;group&#x27;;
      }

      if ( !$component ) {
        return $text;
      }

      switch ( $component ) {

        case &#x27;group&#x27;:

          $start_num = intval( ( $groups_template-&gt;pag_page - 1 ) * $groups_template-&gt;pag_num ) + 1;
          $from_num = bp_core_number_format( $start_num );
          $to_num = bp_core_number_format( ( $start_num + ( $groups_template-&gt;pag_num - 1 ) &gt; $groups_template-&gt;total_group_count ) ? $groups_template-&gt;total_group_count : $start_num + ( $groups_template-&gt;pag_num - 1 ) );
          $total = bp_core_number_format( $groups_template-&gt;total_group_count );

          $total_viewed = $to_num - $from_num;

          /* We are viewing all available groups, no point showing this */
          if ( $total_viewed &lt;= $total ) {
            return;
          }

          break;

      }

      $html[ ] = &#x27;&lt;div class=&quot;page-count&quot;&gt;&#x27;;
      $html[ ] = $text;
      $html[ ] = &#x27;&lt;/div&gt;&#x27;;

      return implode( &#x27;&#x27;, (array)$html );

    }

    /**
     * Adds BuddyPress to the Navbar selection.
     *
     * @author potanin@UD
     */
    function navbar_options( $navbar_options ) {
      global $wp_query;

      $navbar_options[ &#x27;buddypress&#x27; ] = array(
        &#x27;type&#x27; =&gt; &#x27;buddypress&#x27;,
        &#x27;label&#x27; =&gt; __( &#x27;BuddyPress &quot;Admin Bar&quot;&#x27;, &#x27;flawless&#x27; )
      );

      return $navbar_options;

    }

    /**
     * Notifies Flawless if we will have a Navbar.
     *
     * @filter init ( 500 )
     * @author potanin@UD
     */
    function use_navbar( $default ) {
      global $flawless, $bp, $topic_template;

      if ( ( defined( &#x27;BP_DISABLE_ADMIN_BAR&#x27; ) &amp;&amp; BP_DISABLE_ADMIN_BAR ) || $flawless[ &#x27;buddypress&#x27; ][ &#x27;disable_admin_bar&#x27; ] == &#x27;true&#x27; || $flawless[ &#x27;navbar&#x27; ][ &#x27;type&#x27; ] != &#x27;buddypress&#x27; ) {
        return false;
      }

      if ( (int)bp_get_option( &#x27;hide-loggedout-adminbar&#x27; ) &amp;&amp; !is_user_logged_in() ) {
        return false;
      }

      //** Add custom &quot;Manage&quot; toolbar to BP Navbar
      add_action( &#x27;bp_adminbar_menus&#x27;, array( &#x27;Flawless_BuddyPress&#x27;, &#x27;navbar_admin_actions&#x27; ), 200 );

      //** Add Topic Navbar Item */
      if ( $topic_template-&gt;topic_id ) {
        add_action( &#x27;bp_adminbar_menus&#x27;, array( &#x27;Flawless_BuddyPress&#x27;, &#x27;navbar_topic_actions&#x27; ), 250 );
      }

      //** Remove the &quot;Visit&quot; Toolbar Menu */
      remove_action( &#x27;bp_adminbar_menus&#x27;, &#x27;bp_adminbar_random_menu&#x27;, 100 );

      //** Handle BuddyPress-specific navbar settings
      if ( $flawless[ &#x27;buddypress&#x27; ][ &#x27;navbar&#x27; ][ &#x27;hide_dashboard&#x27; ] == &#x27;true&#x27; ) {
        remove_action( &#x27;bp_adminbar_menus&#x27;, &#x27;bp_adminbar_thisblog_menu&#x27;, 6 );
      }

      add_action( &#x27;flawless::navbar_html&#x27;, array( &#x27;Flawless_BuddyPress&#x27;, &#x27;navbar_html&#x27; ) );

      return $default;

    }

    /**
     * Converts, rather hackishly, the default BP &quot;Admin Bar&quot;
     *
     * @todo Modify this to utilize the header-navbar.php file and the header-navbar action
     * @author potanin@UD
     */
    function navbar_html( $html ) {
      global $bp, $flawless;

      if ( Asset::load( &#x27;simple_html_dom&#x27; ) ) {
        //** Get BP Admin bar menu */
        ob_start();
        $bp-&gt;doing_admin_bar = true;
        do_action( &#x27;bp_adminbar_menus&#x27; );
        $bp-&gt;doing_admin_bar = false;
        $contents = ob_get_contents();
        ob_end_clean();

        preg_match( &quot;/^\&lt;ul/&quot;, $contents, $matches );

        if ( empty( $matches ) ) {
          $contents = &quot;&lt;ul&gt;{$contents}&lt;/ul&gt;&quot;;
        }

        $contents = str_replace( array( &#x27;&lt;li id=&quot;&#x27; ), &#x27;&lt;li class=&quot;dropdown&quot; id=&quot;&#x27;, $contents );
        $contents = str_replace( array( &#x27;&lt;ul&gt;&#x27;, &#x27;&lt;ul class=&quot;random-list&quot;&gt;&#x27; ), &#x27;&lt;ul class=&quot;dropdown-menu&quot;&gt;&#x27;, $contents );

        $dom = str_get_html( $contents );
        $menu = $dom-&gt;find( &#x27;ul&#x27;, 0 )-&gt;children();

        if ( empty( $menu ) ) {
          return $html;
        }

        //** Set of not allowed menu items */
        $not_allowed = array(
          &quot;log_in&quot; =&gt; __( &quot;Log In&quot; ),
        );

        //** Go through all main menu items and parse them */
        foreach ( $menu as $li ) {
          $class = &quot;&quot;;
          $link = $li-&gt;find( &#x27;a&#x27;, 0 );
          //** Don&#x27;t add not allowed menu items */
          if ( in_array( $link-&gt;innertext, $not_allowed ) ) continue;
          else $link = $link-&gt;outertext;

          $children = $li-&gt;find( &#x27;ul&#x27;, 0 )-&gt;outertext;
          if ( !empty( $children ) ) {
            $class = &quot;dropdown&quot;;
            if ( strpos( $link, &#x27;class=&#x27; ) === false ) {
              $link = str_replace( &quot;&lt;a &quot;, &quot;&lt;a class=\&quot;dropdown-toggle\&quot; &quot;, $link );
            } else {
              $link = str_replace( &quot;class=\&quot;&quot;, &quot;class=\&quot;dropdown-toggle &quot;, $link );
            }
            $link = str_replace( &quot;&lt;a &quot;, &quot;&lt;a data-toggle=\&quot;dropdown\&quot; &quot;, $link );
            if ( strpos( $link, &#x27;caret&#x27; ) === false ) {
              $link = str_replace( &quot;&lt;/a&gt;&quot;, &quot;&lt;b class=\&quot;dropdown-toggle caret\&quot;&gt;&lt;/b&gt;&lt;/a&gt;&quot;, $link );
            }
          }
          $items[ ] = &quot;&lt;li class=\&quot;{$class}\&quot;&gt;{$link}{$children}&lt;/li&gt;&quot;;
        }
      }

      $html[ &#x27;left&#x27; ] = implode( &#x27;&#x27;, (array)$items );

      return $html;
    }

    /**
     * Display list of groups via shortcode call.
     *
     * @author potanin@UD
     */
    function group_avatar( $atts = false ) {
      return bp_get_group_avatar();
    }

    /**
     * Display current group description via shortcode call.
     *
     * @author potanin@UD
     */
    function group_description( $atts = false ) {
      return bp_get_group_description();
    }

    /**
     * Render the registration form by extracting the code from register.php
     *
     * @author potanin@UD
     */
    function bp_registration_form( $atts = false, $content = false ) {
      global $shortcode_content;

      //** If the shortcode is being requested on admin-side it&#x27;s most likely because Carrington Build is previewing it, in which case we return a short description */
      if ( is_admin() &amp;&amp; current_theme_supports( &#x27;carrington_build&#x27; ) ) {
        return __( &#x27;BuddyPress Registration&#x27;, &#x27;flawless&#x27; );
      }

      //** Add filter to skip the footer when including the template */
      add_filter( &#x27;skip_footer&#x27;, array( __SELF__, &#x27;return_true&#x27; ), 20 );

      //** Use OB to only capture the code between before and after page
      add_action( &#x27;bp_before_register_page&#x27;, create_function( &#x27;&#x27;, &#x27; ob_start();  &#x27; ) );
      add_action( &#x27;bp_after_register_page&#x27;, create_function( &#x27;&#x27;, &#x27; global $shortcode_content; $shortcode_content = ob_get_contents(); ob_end_clean();  &#x27; ) );

      //** Add any custom login here, such as modifying the global $bp variable to make the code in register.php work */

      locate_template( array( &#x27;registration/register.php&#x27; ), true );

      //** Remove the footer skipping so the actual footer doesn&#x27;t get skipped
      remove_filter( &#x27;skip_footer&#x27;, array( __SELF__, &#x27;return_true&#x27; ), 20 );

      return $shortcode_content;

    }

    /**
     * Display current group description via shortcode call.
     *
     * @author potanin@UD
     */
    function group_meta( $atts = false, $content = false ) {
      global $groups_template;

      $atts = wp_parse_args( $atts, array(
        &#x27;meta&#x27; =&gt; false,
        &#x27;do_not_format&#x27; =&gt; false
      ) );

      if ( empty( $atts[ &#x27;meta&#x27; ] ) ) {
        return;
      }

      $value = groups_get_groupmeta( $groups_template-&gt;groups[ $groups_template-&gt;current_group ]-&gt;id, $atts[ &#x27;meta&#x27; ] );

      if ( !$args[ &#x27;do_not_format&#x27; ] ) {
        $value = stripslashes( $value );
      }

      return $value;

    }

    /**
     * Display list of groups via shortcode call.
     *
     * @author potanin@UD
     */
    function buddy_press_groups( $atts = false ) {
      global $groups_template;

      $atts = shortcode_atts( array(
        &#x27;user_id&#x27; =&gt; 0,
        &#x27;max_groups&#x27; =&gt; 5,
        &#x27;item_class&#x27; =&gt; &#x27;group_item&#x27;,
        &#x27;descriptions&#x27; =&gt; &#x27;true&#x27;,
        &#x27;avatars&#x27; =&gt; &#x27;true&#x27;,
        &#x27;titles&#x27; =&gt; &#x27;true&#x27;,
        &#x27;group_type&#x27; =&gt; &#x27;active&#x27;
      ), $atts );

      if ( !bp_has_groups( &#x27;user_id=&#x27; . $atts[ &#x27;user_id&#x27; ] . &#x27;&amp;type=&#x27; . $atts[ &#x27;group_type&#x27; ] . &#x27;&amp;max=&#x27; . $atts[ &#x27;max_groups&#x27; ] ) ) {
        return;
      }

      $html = array();

      $html[ ] = &#x27;&lt;div class=&quot;groups dir-list shortcode&quot;&gt;&#x27;;
      $html[ ] = &#x27;&lt;ul class=&quot;groups-list item-list&quot;&gt;&#x27;;

      while ( bp_groups() ) : bp_the_group();

        $html[ ] = &#x27;&lt;li class=&quot;list-item  &#x27; . $atts[ &#x27;item_class&#x27; ] . &#x27; clearfix&quot;&gt;&#x27;;
        $html[ ] = &#x27;&lt;div class=&quot;clearfix&quot;&gt;&#x27;;

        if ( $atts[ &#x27;avatars&#x27; ] == &#x27;true&#x27; ) {
          $html[ ] = &#x27;&lt;div class=&quot;item-avatar&quot;&gt;&lt;a href=&quot;&#x27; . bp_get_group_permalink() . &#x27;&quot; title=&quot;&#x27; . bp_get_group_name() . &#x27;&quot;&gt;&#x27; . bp_get_group_avatar() . &#x27;&lt;/a&gt;&lt;/div&gt;&#x27;;
        }

        if ( $atts[ &#x27;titles&#x27; ] == &#x27;true&#x27; ) {
          $html[ ] = &#x27;&lt;div class=&quot;item-title&quot;&gt;&lt;a href=&quot;&#x27; . bp_get_group_permalink() . &#x27;&quot; title=&quot;&#x27; . bp_get_group_name() . &#x27;&quot;&gt;&#x27; . bp_get_group_name() . &#x27;&lt;/a&gt;&lt;/div&gt;&#x27;;
        }

        if ( $atts[ &#x27;descriptions&#x27; ] == &#x27;true&#x27; ) {
          $html[ ] = &#x27;&lt;div class=&quot;item-desc&quot;&gt;&#x27; . bp_get_group_description() . &#x27;&lt;/div&gt;&#x27;;
        }

        $html[ ] = &#x27;&lt;/div&gt;&#x27;;
        $html[ ] = &#x27;&lt;/li&gt;&#x27;;

      endwhile;

      $html[ ] = &#x27;&lt;/ul&gt;&#x27;;
      $html[ ] = &#x27;&lt;/div&gt;&#x27;;

      return implode( &#x27;&#x27;, (array)$html );

    }

    /**
     * Displays inline navigation for current BP place.
     *
     *
     * @todo For Group Admin, the groups_admin_tabs action is not honored here.
     * @author potanin@UD
     */
    function render_navigation() {
      global $bp;

      if ( groups_get_groupmeta( $bp-&gt;groups-&gt;current_group-&gt;id, &#x27;hide_navigation&#x27; ) == &#x27;true&#x27; ) {
        return;
      }

      $current_user = wp_get_current_user();

      $component_index = !empty( $bp-&gt;displayed_user ) ? $bp-&gt;current_component : bp_get_root_slug( $bp-&gt;current_component );

      //** If My Profile we override the compontent */
      if ( bp_is_my_profile() ) {
        $component_index = &#x27;member&#x27;;
      }

      if ( !$component_index ) {
        return;
      }

      $menu = array();
      $menu_class = array( &#x27;nav&#x27;, &#x27;nav-tabs&#x27; );

      switch ( $component_index ) {

        case &#x27;member&#x27; :

          $menu_class[ ] = &#x27;bp_nav&#x27;;

          foreach ( (array)$bp-&gt;bp_nav as $user_nav_item ) {

            if ( !$user_nav_item[ &#x27;show_for_displayed_user&#x27; ] &amp;&amp; !bp_is_my_profile() ) {
              continue;
            }

            $menu[ $user_nav_item[ &#x27;slug&#x27; ] ] = $user_nav_item;

            $menu[ $user_nav_item[ &#x27;slug&#x27; ] ][ &#x27;classes&#x27; ] = array( &#x27;bp-menu-item&#x27; );

            if ( $bp-&gt;current_component == $user_nav_item[ &#x27;slug&#x27; ] ) {
              $menu[ $user_nav_item[ &#x27;slug&#x27; ] ][ &#x27;selected&#x27; ] = true;
              $menu[ $user_nav_item[ &#x27;slug&#x27; ] ][ &#x27;classes&#x27; ][ ] = &#x27;active&#x27;;
              $selected = &#x27; class=&quot;current selected&quot;&#x27;;
            } else {
              $selected = &#x27;&#x27;;
            }

            if ( $bp-&gt;loggedin_user-&gt;domain ) {
              $link = str_replace( $bp-&gt;loggedin_user-&gt;domain, $bp-&gt;displayed_user-&gt;domain, $user_nav_item[ &#x27;link&#x27; ] );
            } else {
              $link = $bp-&gt;displayed_user-&gt;domain . $user_nav_item[ &#x27;link&#x27; ];
            }

            $menu[ $user_nav_item[ &#x27;slug&#x27; ] ][ &#x27;link&#x27; ] = $link;
            $menu[ $user_nav_item[ &#x27;slug&#x27; ] ][ &#x27;id&#x27; ] = $user_nav_item[ &#x27;css_id&#x27; ] . &#x27;-personal-li&#x27;;
            $menu[ $user_nav_item[ &#x27;slug&#x27; ] ][ &#x27;css&#x27; ] = &#x27;user-&#x27; . $user_nav_item[ &#x27;css_id&#x27; ];
            $menu[ $user_nav_item[ &#x27;slug&#x27; ] ][ &#x27;html&#x27; ] = apply_filters_ref_array( &#x27;bp_get_displayed_user_nav_&#x27; . $user_nav_item[ &#x27;css_id&#x27; ], array( &#x27;&lt;li id=&quot;&#x27; . $user_nav_item[ &#x27;css_id&#x27; ] . &#x27;-personal-li&quot; &#x27; . $selected . &#x27;&gt;&lt;a id=&quot;user-&#x27; . $user_nav_item[ &#x27;css_id&#x27; ] . &#x27;&quot; href=&quot;&#x27; . $link . &#x27;&quot;&gt;&#x27; . $user_nav_item[ &#x27;name&#x27; ] . &#x27;&lt;/a&gt;&lt;/li&gt;&#x27;, &amp;$user_nav_item ) );

            if ( $bp-&gt;bp_options_nav[ $user_nav_item[ &#x27;slug&#x27; ] ] ) {
              $menu[ $user_nav_item[ &#x27;slug&#x27; ] ][ &#x27;submenu&#x27; ] = $bp-&gt;bp_options_nav[ $user_nav_item[ &#x27;slug&#x27; ] ];
            }

          }

          break;

        default:

          $menu_class[ ] = &#x27;bp_nav&#x27;;

          if ( !bp_is_single_item() ) {
            if ( !isset( $bp-&gt;bp_options_nav[ $component_index ] ) || count( $bp-&gt;bp_options_nav[ $component_index ] ) &lt; 1 ) {
              return false;
            } else {
              $the_index = $component_index;
            }
          } else {
            if ( !isset( $bp-&gt;bp_options_nav[ $bp-&gt;current_item ] ) || count( $bp-&gt;bp_options_nav[ $bp-&gt;current_item ] ) &lt; 1 ) {
              return false;
            } else {
              $the_index = $bp-&gt;current_item;
            }
          }

          //** Loop through each navigation item */
          foreach ( (array)$bp-&gt;bp_options_nav[ $the_index ] as $subnav_item ) {

            if ( !$subnav_item[ &#x27;user_has_access&#x27; ] ) {
              continue;
            }

            $menu[ $subnav_item[ &#x27;slug&#x27; ] ] = $subnav_item;
            $menu[ $subnav_item[ &#x27;slug&#x27; ] ][ &#x27;classes&#x27; ] = array( &#x27;bp-menu-item&#x27; );

            //** If the current action or an action variable matches the nav item id, then add a highlight CSS class. */
            if ( $subnav_item[ &#x27;slug&#x27; ] == $bp-&gt;current_action ) {
              $selected = &#x27; class=&quot;current selected&quot;&#x27;;
              $menu[ $subnav_item[ &#x27;slug&#x27; ] ][ &#x27;selected&#x27; ] = true;
              $menu[ $subnav_item[ &#x27;slug&#x27; ] ][ &#x27;classes&#x27; ][ ] = &#x27;active&#x27;;
            } else {
              $selected = &#x27;&#x27;;
            }

            //** List type depends on our current component */
            $list_type = bp_is_group() ? &#x27;groups&#x27; : &#x27;personal&#x27;;

            $menu[ $subnav_item[ &#x27;slug&#x27; ] ][ &#x27;css&#x27; ] = $subnav_item;
            $menu[ $subnav_item[ &#x27;slug&#x27; ] ][ &#x27;id&#x27; ] = $subnav_item[ &#x27;css_id&#x27; ] . &#x27;-&#x27; . $list_type . &#x27;-li&#x27;;
            $menu[ $subnav_item[ &#x27;slug&#x27; ] ][ &#x27;html&#x27; ] = apply_filters( &#x27;bp_get_options_nav_&#x27; . $subnav_item[ &#x27;css_id&#x27; ], &#x27;&lt;li id=&quot;&#x27; . $subnav_item[ &#x27;css_id&#x27; ] . &#x27;-&#x27; . $list_type . &#x27;-li&quot; &#x27; . $selected . &#x27;&gt;&lt;a id=&quot;&#x27; . $subnav_item[ &#x27;css_id&#x27; ] . &#x27;&quot; href=&quot;&#x27; . $subnav_item[ &#x27;link&#x27; ] . &#x27;&quot;&gt;&#x27; . $subnav_item[ &#x27;name&#x27; ] . &#x27;&lt;/a&gt;&lt;/li&gt;&#x27;, $subnav_item );

            //** If this is the Groups Admin menu, we add submenus */
            if ( $component_index == &#x27;groups&#x27; &amp;&amp; $subnav_item[ &#x27;slug&#x27; ] == &#x27;admin&#x27; ) {

              $group = ( $groups_template-&gt;group ) ? $groups_template-&gt;group : $bp-&gt;groups-&gt;current_group;

              $current_tab = bp_action_variable( 0 );

              //** Add Details Submenu */
              if ( $bp-&gt;is_item_admin || $bp-&gt;is_item_mod ) {
                $menu[ $subnav_item[ &#x27;slug&#x27; ] ][ &#x27;submenu&#x27; ][ ] = array(
                  &#x27;name&#x27; =&gt; __( &#x27;Details&#x27;, &#x27;buddypress&#x27; ),
                  &#x27;link&#x27; =&gt; bp_get_root_domain() . &#x27;/&#x27; . bp_get_groups_root_slug() . &#x27;/&#x27; . $group-&gt;slug . &#x27;/admin/edit-details&#x27;
                );
              }

              if ( !$bp-&gt;is_item_admin ) {
                continue;
              }

              $menu[ $subnav_item[ &#x27;slug&#x27; ] ][ &#x27;submenu&#x27; ][ ] = array(
                &#x27;name&#x27; =&gt; __( &#x27;Settings&#x27;, &#x27;buddypress&#x27; ),
                &#x27;link&#x27; =&gt; bp_get_root_domain() . &#x27;/&#x27; . bp_get_groups_root_slug() . &#x27;/&#x27; . $group-&gt;slug . &#x27;/admin/group-settings&#x27;
              );

              if ( !(int)bp_get_option( &#x27;bp-disable-avatar-uploads&#x27; ) ) {
                $menu[ $subnav_item[ &#x27;slug&#x27; ] ][ &#x27;submenu&#x27; ][ ] = array(
                  &#x27;name&#x27; =&gt; __( &#x27;Avatar&#x27;, &#x27;buddypress&#x27; ),
                  &#x27;link&#x27; =&gt; bp_get_root_domain() . &#x27;/&#x27; . bp_get_groups_root_slug() . &#x27;/&#x27; . $group-&gt;slug . &#x27;/admin/group-avatar&#x27;
                );
              }

              $menu[ $subnav_item[ &#x27;slug&#x27; ] ][ &#x27;submenu&#x27; ][ ] = array(
                &#x27;name&#x27; =&gt; __( &#x27;Members&#x27;, &#x27;buddypress&#x27; ),
                &#x27;link&#x27; =&gt; bp_get_root_domain() . &#x27;/&#x27; . bp_get_groups_root_slug() . &#x27;/&#x27; . $group-&gt;slug . &#x27;/admin/manage-members&#x27;
              );

              if ( $groups_template-&gt;group-&gt;status == &#x27;private&#x27; ) {
                $menu[ $subnav_item[ &#x27;slug&#x27; ] ][ &#x27;submenu&#x27; ][ ] = array(
                  &#x27;name&#x27; =&gt; __( &#x27;Requests&#x27;, &#x27;buddypress&#x27; ),
                  &#x27;link&#x27; =&gt; bp_get_root_domain() . &#x27;/&#x27; . bp_get_groups_root_slug() . &#x27;/&#x27; . $group-&gt;slug . &#x27;/admin/membership-requests&#x27;
                );
              }

              $menu[ $subnav_item[ &#x27;slug&#x27; ] ][ &#x27;submenu&#x27; ][ ] = array(
                &#x27;name&#x27; =&gt; __( &#x27;Delete&#x27;, &#x27;buddypress&#x27; ),
                &#x27;link&#x27; =&gt; bp_get_root_domain() . &#x27;/&#x27; . bp_get_groups_root_slug() . &#x27;/&#x27; . $group-&gt;slug . &#x27;/admin/delete-group&#x27;
              );

            }

          }

          break;

      }

      $html = array();

      $html[ ] = &#x27;&lt;ul class=&quot;&#x27; . implode( &#x27; &#x27;, (array)$menu_class ) . &#x27;&quot;&gt;&#x27;;

      foreach ( (array)$menu as $slug =&gt; $settings ) {

        if ( $settings[ &#x27;submenu&#x27; ] ) {
          $settings[ &#x27;classes&#x27; ][ ] = &#x27;dropdown&#x27;;
        }

        $html[ ] = &#x27;&lt;li class=&quot;&#x27; . implode( &#x27; &#x27;, (array)$settings[ &#x27;classes&#x27; ] ) . &#x27;&quot;&gt;&#x27;;

        if ( $settings[ &#x27;submenu&#x27; ] ) {
          $html[ ] = &#x27;&lt;a href=&quot;&#x27; . $settings[ &#x27;link&#x27; ] . &#x27;&quot; class=&quot;dropdown-toggle&quot; data-toggle=&quot;dropdown&quot;&gt;&#x27;;
        } else {
          $html[ ] = &#x27;&lt;a href=&quot;&#x27; . $settings[ &#x27;link&#x27; ] . &#x27;&quot; class=&quot;&quot;&gt;&#x27;;
        }

        $html[ ] = $settings[ &#x27;name&#x27; ];

        if ( $settings[ &#x27;submenu&#x27; ] ) {
          $html[ ] = &#x27;&lt;b class=&quot;caret&quot;&gt;&lt;/b&gt;&#x27;;
        }

        $html[ ] = &#x27;&lt;/a&gt;&#x27;;

        if ( $settings[ &#x27;submenu&#x27; ] ) {
          $html[ ] = &#x27;&lt;ul class=&quot;dropdown-menu&quot;&gt;&#x27;;

          foreach ( (array)$settings[ &#x27;submenu&#x27; ] as $ss ) {
            $html[ ] = &#x27;&lt;li&gt;&lt;a href=&quot;&#x27; . $ss[ &#x27;link&#x27; ] . &#x27;&quot;&gt;&#x27; . $ss[ &#x27;name&#x27; ] . &#x27;&lt;/a&gt;&lt;/li&gt;&#x27;;
          }

          $html[ ] = &#x27;&lt;/ul&gt;&#x27;;
        }

        $html[ ] = &#x27;&lt;/li&gt;&#x27;;

      }

      //** Support for default BuddyPress API hook */
      ob_start();
      do_action( &#x27;bp_&#x27; . $component_index . &#x27;_options_nav&#x27; );
      $html[ ] = ob_get_contents();
      ob_end_clean();

      $html[ ] = &#x27;&lt;/ul&gt;&#x27;;

      echo implode( &#x27;&#x27;, (array)$html );

    }

    /**
     * Force Flawless template_redirect to be loaded in BuddyPress
     *
     * @todo This code is very UD-specific, needs to be migrated out once proof of concept is done.
     * @todo Add sort by usage to $current_filters
     *
     * @author potanin@UD
     */
    function get_json_topics( $args = false ) {
      global $forum_template, $topic_template, $wpdb;

      $_forum_template = $forum_template;

      /* Declare our supported forum IDs */
      $supported_forums = array( 1, 5, 6, 8 ); /* WPP, WPI, Denali, CRM */

      /* Overwrite $args with $_REQUEST if it exists */
      if ( !$args &amp;&amp; $_REQUEST ) {
        $args = $_REQUEST;
      }

      $args = wp_parse_args( $args, array(
        &#x27;json_result&#x27; =&gt; true,
        &#x27;use_cache&#x27; =&gt; true,
        &#x27;request_range&#x27; =&gt; array(
          &#x27;start&#x27; =&gt; 0,
          &#x27;end&#x27; =&gt; 10
        ),
        &#x27;minimum_filter_usage&#x27; =&gt; 0,
        &#x27;filterable_attributes&#x27; =&gt; array(),
        &#x27;query&#x27; =&gt; array(
          &#x27;per_page&#x27; =&gt; -1
        )
      ) );

      if ( !empty( $args[ &#x27;filter_query&#x27; ][ &#x27;search_terms&#x27; ] ) ) {
        $args[ &#x27;query&#x27; ][ &#x27;search_terms&#x27; ] = $args[ &#x27;filter_query&#x27; ][ &#x27;search_terms&#x27; ];
      }

      if ( !empty( $args[ &#x27;filter_query&#x27; ][ &#x27;topic_type&#x27; ] ) ) {
        $topic_type = $args[ &#x27;filter_query&#x27; ][ &#x27;topic_type&#x27; ][ 0 ];
      }

      if ( !empty( $args[ &#x27;filter_query&#x27; ][ &#x27;object_name&#x27; ] ) ) {
        $forum_id = $wpdb-&gt;get_var( &quot;SELECT forum_id FROM {$wpdb-&gt;prefix}bb_forums WHERE forum_name = &#x27;{$args[ &#x27;filter_query&#x27; ][ &#x27;object_name&#x27; ][0]}&#x27; &quot; );
        $args[ &#x27;query&#x27; ][ &#x27;forum_id&#x27; ] = $forum_id;
      }

      //** Always create transiet key because results are always cached */
      $args[ &#x27;transient_key&#x27; ] = &#x27;bp_t_&#x27; . md5( serialize( $args[ &#x27;query&#x27; ] ) );
      $args[ &#x27;cache_timeout&#x27; ] = is_numeric( $args[ &#x27;use_cache&#x27; ] ) ? $args[ &#x27;use_cache&#x27; ] : 600;

      /** For now, we can&#x27;t use cache - everything is determined by SQL */
      $results = false;
      $args[ &#x27;use_cache&#x27; ] = false;

      /* Disabled - this will break JSON response - potanin@UD */
      /* if(isset($args[&#x27;debug&#x27;]) &amp;&amp; $args[&#x27;debug&#x27;]) $wpdb-&gt;show_errors(); */

      /* If we don&#x27;t have results. */
      if ( empty( $results[ &#x27;all_results&#x27; ] ) ) {

        /* Start to build our query */
        $query = &quot;SELECT t.*, f.forum_slug, f.forum_name, MIN( CASE WHEN m.meta_key =  &#x27;ud_support_created&#x27; THEN m.meta_value END ) AS premium FROM {$wpdb-&gt;prefix}bb_topics AS t INNER JOIN {$wpdb-&gt;prefix}bb_posts AS p ON t.topic_id = p.topic_id LEFT JOIN {$wpdb-&gt;prefix}bb_forums AS f ON t.forum_id = f.forum_id JOIN {$wpdb-&gt;prefix}bb_meta AS m ON t.topic_id = m.object_id WHERE m.object_type = &#x27;bb_topic&#x27; AND t.topic_status = 0&quot;;

        /* Add on our where clauses */
        $filter =&amp; $args[ &#x27;filter_query&#x27; ];

        /* Supported forums */
        $query .= &quot; AND ( f.forum_id IN (&quot; . implode( &#x27;,&#x27;, $supported_forums ) . &quot;) )&quot;;

        /* Search box */
        if ( isset( $filter[ &#x27;search_terms&#x27; ] ) &amp;&amp; !empty( $filter[ &#x27;search_terms&#x27; ] ) ) {
          /* Use Boolean mode search */
          $query .= &quot; AND ( MATCH (t.topic_title, p.post_text) AGAINST (&#x27;&quot; . $wpdb-&gt;escape( $filter[ &#x27;search_terms&#x27; ] ) . &quot;&#x27; IN BOOLEAN MODE) )&quot;;
        }

        /* Voices / Posts Count */
        if ( isset( $filter[ &#x27;topic_posts&#x27; ] ) &amp;&amp; !empty( $filter[ &#x27;topic_posts&#x27; ] ) ) {
          /* Use Boolean mode search */
          $query .= &quot; AND ( topic_posts BETWEEN {$filter[ topic_posts ][min]} AND {$filter[ topic_posts ][max]} )&quot;;
        }

        /* Forum */
        if ( isset( $filter[ &#x27;object_name&#x27; ] ) &amp;&amp; is_array( $filter[ &#x27;object_name&#x27; ] ) &amp;&amp; !empty( $filter[ &#x27;object_name&#x27; ] ) ) {
          /* Setup our forum map from key to ID */
          $t = $wpdb-&gt;get_results( &quot;SELECT forum_id, forum_name FROM {$wpdb-&gt;prefix}bb_forums&quot;, ARRAY_A );
          $forums_map = array();

          foreach ( $t as $arr ) {
            $forums_map[ $arr[ &#x27;forum_name&#x27; ] ] = $arr[ &#x27;forum_id&#x27; ];
          }
          $ids = array();
          foreach ( $filter[ &#x27;object_name&#x27; ] as $name ) {
            if ( in_array( $name, array_keys( $forums_map ) ) ) {
              $ids[ ] = $forums_map[ $name ];
            }
          }
          if ( count( $ids ) ) {
            $query .= &quot; AND ( p.forum_id IN ( &quot; . implode( &quot;,&quot;, $ids ) . &quot; ) OR t.forum_id IN ( &quot; . implode( &quot;,&quot;, $ids ) . &quot; ) )&quot;;
          }
        }

        /* Add our group by */
        $query .= &quot; GROUP BY t.topic_id &quot;;

        /* We add the having statement after the group by always */
        /* Premium vs Regular */
        if ( isset( $filter[ &#x27;topic_type&#x27; ] ) &amp;&amp; is_array( $filter[ &#x27;topic_type&#x27; ] ) &amp;&amp; !empty( $filter[ &#x27;topic_type&#x27; ] ) ) {
          /* If we have a search term */
          if ( count( $filter[ &#x27;topic_type&#x27; ] ) == 1 ) {
            $null = &quot;IS NOT NULL&quot;;
            if ( $filter[ &#x27;topic_type&#x27; ][ 0 ] == &quot;Regular&quot; ) $null = &quot;IS NULL&quot;;
            $query .= &quot; HAVING ( MIN( CASE WHEN m.meta_key =  &#x27;ud_support_created&#x27; THEN m.meta_value END ) {$null} )&quot;;
          }
        }

        /* @todo Add sort by when Andy is ready - williams@UD */
        $query .= &quot; ORDER BY p.post_time DESC&quot;;

        /** Create our temporary table */
        $wpdb-&gt;query( &quot;CREATE TEMPORARY TABLE {$args[&#x27;transient_key&#x27;]} {$query}&quot; );

        /** Reset our query */
        $query = &quot;SELECT * FROM {$args[&#x27;transient_key&#x27;]}&quot;;

        /** Run the query once to get all the ids */
        $all_ids = $wpdb-&gt;get_col( $query, 0 );

        /** Add in our limiters, then get the specific IDs */
        $query .= &quot; LIMIT {$args[ &#x27;request_range&#x27; ][&#x27;start&#x27;]}, {$args[&#x27;dom_limit&#x27;]}&quot;;

        /** Get the specific ids */
        $data = $wpdb-&gt;get_results( $query, ARRAY_A );

        /** Load buddypress */
        bp_forums_load_bbpress();

        /** Now that we have our data, lets go through and add our additional stuff */
        foreach ( $data as &amp;$row ) {
          $row[ &#x27;object_name&#x27; ] = $row[ &#x27;forum_name&#x27; ];
          $row[ &#x27;topic_link&#x27; ] = home_url( &quot;products/{$row[&#x27;forum_slug&#x27;]}/forum/topic/{$row[&#x27;topic_slug&#x27;]}/&quot; );
          $row[ &#x27;topic_type&#x27; ] = ( is_numeric( $row[ &#x27;premium&#x27; ] ) ? &#x27;Premium&#x27; : &#x27;Regular&#x27; );
          $row[ &#x27;topic_tags&#x27; ] = ( $row[ &#x27;tag_count&#x27; ] ? bb_get_topic_tags( $row[ &#x27;topic_id&#x27; ], array( &#x27;fields&#x27; =&gt; &#x27;names&#x27;, &#x27;topic_id&#x27; =&gt; $row[ &#x27;topic_id&#x27; ] ) ) : array() );
          $row[ &#x27;freshness&#x27; ] = bp_core_time_since( strtotime( $row[ &#x27;topic_time&#x27; ] ) );
          $row[ &#x27;group_link&#x27; ] = site_url( &quot;products/{$row[&#x27;forum_slug&#x27;]}/&quot; );
          $row[ &#x27;group_avatar&#x27; ] = bp_core_fetch_avatar( array( &#x27;item_id&#x27; =&gt; $row[ &#x27;forum_id&#x27; ], &#x27;object&#x27; =&gt; &#x27;group&#x27;, &#x27;type&#x27; =&gt; &#x27;thumb&#x27;, &#x27;width&#x27; =&gt; false, &#x27;height&#x27; =&gt; false, &#x27;html&#x27; =&gt; false ) );
          $row[ &#x27;last_poster_avatar&#x27; ] = bp_core_fetch_avatar( array( &#x27;type&#x27; =&gt; &#x27;thumb&#x27;, &#x27;width&#x27; =&gt; false, &#x27;height&#x27; =&gt; false, &#x27;item_id&#x27; =&gt; $row[ &#x27;topic_last_poster&#x27; ], &#x27;html&#x27; =&gt; false ) );
        }

        /** Now, for each filterable item, lets figure out the counts */
        $current_filters = array();

        foreach ( (array)$args[ &#x27;filterable_attributes&#x27; ] as $filter_key =&gt; $filter_data ) {
          switch ( $filter_data[ &#x27;filter_type&#x27; ] ) {

            case &#x27;checkbox&#x27;:

              switch ( $filter_key ) {
                case &#x27;object_name&#x27;:
                  $filter_query = &quot;SELECT forum_name AS &#x60;label&#x60;, count(*) AS &#x60;usage_count&#x60; FROM {$args[&#x27;transient_key&#x27;]} GROUP BY forum_name HAVING count(*) &gt; 0 ORDER BY usage_count DESC LIMIT 10&quot;;
                  break;
                case &#x27;topic_type&#x27;:
                  $filter_query = &quot;SELECT &#x27;Regular&#x27; AS &#x60;label&#x60;, count(*) as &#x60;usage_count&#x60; FROM {$args[&#x27;transient_key&#x27;]} WHERE premium IS NULL&quot;;
                  break;
                default:
                  $filter_query = false;
                  break;
              }

              /* Run the filter query */
              if ( $filter_query ) {
                $current_filters[ $filter_key ] = $wpdb-&gt;get_results( $filter_query, ARRAY_A );
              }

              /* Do our special consideration for topic_type */
              if ( $filter_key == &#x27;topic_type&#x27; ) {
                $t =&amp; $current_filters[ $filter_key ];
                $t[ ] = array(
                  &#x27;label&#x27; =&gt; &#x27;Premium&#x27;,
                  &#x27;usage_count&#x27; =&gt; count( $all_ids ) - $t[ 0 ][ &#x27;usage_count&#x27; ],
                );
                if ( $t[ 0 ][ &#x27;usage_count&#x27; ] &lt; $t[ 1 ][ &#x27;usage_count&#x27; ] ) {
                  $t = array(
                    array(
                      &#x27;label&#x27; =&gt; $t[ 1 ][ &#x27;label&#x27; ],
                      &#x27;usage_count&#x27; =&gt; $t[ 1 ][ &#x27;usage_count&#x27; ],
                    ),
                    array(
                      &#x27;label&#x27; =&gt; $t[ 0 ][ &#x27;label&#x27; ],
                      &#x27;usage_count&#x27; =&gt; $t[ 0 ][ &#x27;usage_count&#x27; ],
                    )
                  );
                }
              }
              break;

            case &#x27;date_range&#x27;:
            case &#x27;range&#x27;:

              $current_filters[ $filter_key ][ &#x27;values&#x27; ][ &#x27;max&#x27; ] = $wpdb-&gt;get_var( &quot;SELECT MAX(topic_posts) FROM {$args[&#x27;transient_key&#x27;]}&quot; );
              $current_filters[ $filter_key ][ &#x27;values&#x27; ][ &#x27;min&#x27; ] = $wpdb-&gt;get_var( &quot;SELECT MIN(topic_posts) FROM {$args[&#x27;transient_key&#x27;]}&quot; );

              break;

            case &#x27;input&#x27;:

              $current_filters[ $filter_key ] = array( array(
                &#x27;values&#x27; =&gt; ( isset( $args[ &#x27;filter_query&#x27; ][ $filter_key ] ) &amp;&amp; !empty( $args[ &#x27;filter_query&#x27; ][ $filter_key ] ) ? $args[ &#x27;filter_query&#x27; ][ $filter_key ] : &#x27;&#x27; ),
              ) );

              break;

          }
        }

        /* These results are cached in transient */
        $results[ &#x27;all_results&#x27; ] = apply_filters( &#x27;all_results&#x27;, $data );
        $results[ &#x27;total_results&#x27; ] = count( $all_ids );
        $results[ &#x27;current_filters&#x27; ] = $current_filters;

        /* Cache topic results, if set. */
        set_transient( $args[ &#x27;transient_key&#x27; ], $results, $args[ &#x27;cache_timeout&#x27; ] );

        $results[ &#x27;cached_used&#x27; ] = false;

      } else {
        $results[ &#x27;cached_used&#x27; ] = true;

      }

      /* Sliced result are not cached */
      //$results[ &#x27;all_results&#x27; ] = array_slice( (array) $results[ &#x27;all_results&#x27; ], $args[ &#x27;request_range&#x27; ][ &#x27;start&#x27; ], $args[ &#x27;dom_limit&#x27;] );

      /* If in debug mode - these are not cached */
      if ( $args[ &#x27;debug&#x27; ] ) {
        $results[ &#x27;args&#x27; ] = $args;
        $results[ &#x27;sql_queries&#x27; ] = $wpdb-&gt;num_queries;
        $results[ &#x27;transient_key&#x27; ] = $args[ &#x27;transient_key&#x27; ];
      }

      $results[ &#x27;server_driven&#x27; ] = true;
      $results[ &#x27;timer&#x27; ] = timer_stop();
      $results[ &#x27;cache_timeout&#x27; ] = $args[ &#x27;cache_timeout&#x27; ];

      if ( $args[ &#x27;json_result&#x27; ] ) {

        /* Set the return type */
        header( &#x27;Content-Type: application/json&#x27; );

        /* Do the JSON encode */
        $results = json_encode( $results );

        /* If we&#x27;re a human */
        if ( isset( $args[ &#x27;human&#x27; ] ) ) $results = flawless_human_json( $results );

      }

      //** Restore any global variables */
      $forum_template = $_forum_template;

      /* If we&#x27;re here, we return normal json */
      return $results;

    }

    /**
     * Intercept BuddyPress temploate loader and disable it if the current page has a meta setting.
     *
     * Unsetting $bp-&gt;is_single_item prevents BP from loading on Single Group Pages
     *
     * @filter bp_is_current_component
     * @author potanin@UD
     */
    function bp_is_current_component( $is_current_component, $component ) {
      global $wp_filter, $wp_query, $post, $bp;

      //** Get first result from query, because WP will attempt to find a match and will cycle through multiple $post objects */
      $post_id = $wp_query-&gt;posts[ 0 ]-&gt;ID;

      //** If $is_current_component is already false, or there is no post object loaded, we return default */
      if ( !$is_current_component || !$post_id ) {
        return $is_current_component;
      }

      $primary_pages = array();

      //** Build array of post IDs of &quot;Primary&quot; BuddyPress pages */
      foreach ( $bp-&gt;pages as $slug =&gt; $settings ) {
        $primary_pages[ ] = $settings-&gt;id;
      }

      //** If current request is not a primary page, but a corresponding WP page exists, we load the WP page */
      if ( $wp_query-&gt;post_count == 1 &amp;&amp; !$wp_query-&gt;query_vars[ &#x27;404&#x27; ] &amp;&amp; !in_array( $post_id, $primary_pages ) ) {
        $bp-&gt;is_single_item = false;
        $bp-&gt;use_default_page = true;
        return false;
      }

      //** If this is not explicitly set to by &#x27;true&#x27;, we return default */
      if ( $wp_query-&gt;posts[ 0 ]-&gt;post_name == &#x27;register&#x27; || get_post_meta( $post_id, &#x27;override_buddypress_template&#x27;, true ) != &#x27;true&#x27; ) {
        /* we still want use buddypress workflow of signup but at the end we break theirs template output. So we load our register page */
        return $is_current_component;
      }

      //** At this point this page must be set to not use the BP template */
      $bp-&gt;use_default_page = true;
      return false;

    }

    /**
     * Add Layout Editor button to BuddyPress toolbar
     *
     * @author potanin@UD
     */
    function navbar_admin_actions() {
      global $post;

      if ( !is_user_logged_in() ) {
        return;
      }

      $links = array();

      if ( current_user_can( &#x27;manage_options&#x27; ) &amp;&amp; !is_admin() ) {
        $links[ ] = &#x27;&lt;li class=&quot;no-arrow&quot;&gt;&lt;a href=&quot;&#x27; . admin_url() . &#x27;&quot;&gt;&#x27; . __( &#x27;Dashboard&#x27;, &#x27;flawless&#x27; ) . &#x27;&lt;/a&gt;&lt;/li&gt;&#x27;;
      }

      if ( is_user_logged_in() &amp;&amp; bp_user_can_create_groups() ) {
        $links[ ] = &#x27;&lt;li id=&quot;bp-adminbar-groupoptions-menu&quot;&gt;&lt;a href=&quot;&#x27; . trailingslashit( bp_get_root_domain() . &#x27;/&#x27; . bp_get_groups_root_slug() . &#x27;/create&#x27; ) . &#x27;&quot;&gt;&#x27; . __( &#x27;Create a Group&#x27;, &#x27;buddypress&#x27; ) . &#x27;&lt;/a&gt;&lt;/li&gt;&#x27;;
      }

      if ( $post &amp;&amp; $url = get_edit_post_link( $post-&gt;ID ) ) {
        $post_type_obj = get_post_type_object( $post-&gt;post_type );
        $links[ ] = &#x27;&lt;li&gt;&lt;a class=&quot;post-edit-link&quot; href=&quot;&#x27; . $url . &#x27;&quot; title=&quot;&#x27; . esc_attr( $post_type_obj-&gt;labels-&gt;edit_item ) . &#x27;&quot;&gt;&#x27; . $post_type_obj-&gt;labels-&gt;edit_item . &#x27;&lt;/a&gt;&lt;/li&gt;&#x27;;
      }

      if ( current_user_can( &#x27;manage_options&#x27; ) &amp;&amp; !is_admin() ) {
        $links[ ] = &#x27;&lt;li class=&quot;no-arrow&quot;&gt;&lt;a href=&quot;&#x27; . admin_url( &#x27;themes.php?page=functions.php&#x27; ) . &#x27;&quot;&gt;&#x27; . __( &#x27;Theme Settings&#x27;, &#x27;flawless&#x27; ) . &#x27;&lt;/a&gt;&lt;/li&gt;&#x27;;
        $links[ ] = &#x27;&lt;li class=&quot;no-arrow&quot;&gt;&lt;a href=&quot;&#x27; . admin_url( &#x27;widgets.php&#x27; ) . &#x27;&quot;&gt;&#x27; . __( &#x27;Widgets&#x27;, &#x27;flawless&#x27; ) . &#x27;&lt;/a&gt;&lt;/li&gt;&#x27;;
      }

      if ( current_user_can( &#x27;list_users&#x27; ) &amp;&amp; !is_admin() ) {
        $links[ ] = &#x27;&lt;li class=&quot;no-arrow&quot;&gt;&lt;a href=&quot;&#x27; . admin_url( &#x27;users.php&#x27; ) . &#x27;&quot;&gt;&#x27; . __( &#x27;View Users&#x27;, &#x27;flawless&#x27; ) . &#x27;&lt;/a&gt;&lt;/li&gt;&#x27;;
      }

      $links = apply_filters( &#x27;flawless::bp_navbar_admin_links&#x27;, $links );

      if ( empty( $links ) ) {
        return;
      }

      ?&gt;
      &lt;li class=&quot;dropdown&quot;&gt;
        &lt;a href=&quot;&lt;?php echo admin_url(); ?&gt;&quot; class=&quot;dropdown-toggle&quot;
           data-toggle=&quot;dropdown&quot;&gt;&lt;?php _e( &#x27;Manage&#x27;, &#x27;flawless&#x27; ); ?&gt;&lt;b class=&quot;caret&quot;&gt;&lt;/b&gt;&lt;/a&gt;
        &lt;ul class=&quot;dropdown-menu&quot;&gt;&lt;?php echo implode( &#x27;&#x27;, (array)$links ); ?&gt;&lt;/ul&gt;
      &lt;/li&gt;
    &lt;?php

    }

    /**
     * Add Layout Editor button to BuddyPress toolbar
     *
     * @author potanin@UD
     */
    function navbar_topic_actions() {
      global $bp, $forum_template;

      if ( !is_user_logged_in() ) {
        return;
      }

      $links = array();

      if ( bp_group_is_admin() || bp_group_is_mod() || bp_get_the_topic_is_mine() ) {

        $links[ ] = &#x27;&lt;li class=&quot;no-arrow&quot;&gt;&lt;a href=&quot;&#x27; . wp_nonce_url( bp_get_the_topic_permalink() . &#x27;edit&#x27;, &#x27;bp_forums_edit_topic&#x27; ) . &#x27;&quot;&gt;&#x27; . __( &#x27;Edit Topic&#x27;, &#x27;buddypress&#x27; ) . &#x27;&lt;/a&gt;&lt;/li&gt;&#x27;;

        if ( $bp-&gt;is_item_admin || $bp-&gt;is_item_mod || is_super_admin() ) {
          if ( 0 == (int)$forum_template-&gt;topic-&gt;topic_sticky ) {
            $links[ ] = &#x27;&lt;li class=&quot;no-arrow&quot;&gt;&lt;a href=&quot;&#x27; . wp_nonce_url( bp_get_the_topic_permalink() . &#x27;stick&#x27;, &#x27;bp_forums_stick_topic&#x27; ) . &#x27;&quot;&gt;&#x27; . __( &#x27;Sticky Topic&#x27;, &#x27;buddypress&#x27; ) . &#x27;&lt;/a&gt;&lt;/li&gt;&#x27;;
          } else {
            $links[ ] = &#x27;&lt;li class=&quot;no-arrow&quot;&gt;&lt;a href=&quot;&#x27; . wp_nonce_url( bp_get_the_topic_permalink() . &#x27;unstick&#x27;, &#x27;bp_forums_unstick_topic&#x27; ) . &#x27;&quot;&gt;&#x27; . __( &#x27;Un-stick Topic&#x27;, &#x27;buddypress&#x27; ) . &#x27;&lt;/a&gt;&lt;/li&gt;&#x27;;
          }

          if ( 0 == (int)$forum_template-&gt;topic-&gt;topic_open ) {
            $links[ ] = &#x27;&lt;li class=&quot;no-arrow&quot;&gt;&lt;a href=&quot;&#x27; . wp_nonce_url( bp_get_the_topic_permalink() . &#x27;open&#x27;, &#x27;bp_forums_open_topic&#x27; ) . &#x27;&quot;&gt;&#x27; . __( &#x27;Open Topic&#x27;, &#x27;buddypress&#x27; ) . &#x27;&lt;/a&gt;&lt;/li&gt;&#x27;;
          } else {
            $links[ ] = &#x27;&lt;li class=&quot;no-arrow&quot;&gt;&lt;a href=&quot;&#x27; . wp_nonce_url( bp_get_the_topic_permalink() . &#x27;close&#x27;, &#x27;bp_forums_close_topic&#x27; ) . &#x27;&quot;&gt;&#x27; . __( &#x27;Close Topic&#x27;, &#x27;buddypress&#x27; ) . &#x27;&lt;/a&gt;&lt;/li&gt;&#x27;;
          }

          $links[ ] = &#x27;&lt;li class=&quot;no-arrow&quot;&gt;&lt;a class=&quot;confirm&quot; id=&quot;topic-delete-link&quot; href=&quot;&#x27; . wp_nonce_url( bp_get_the_topic_permalink() . &#x27;delete&#x27;, &#x27;bp_forums_delete_topic&#x27; ) . &#x27;&quot;&gt;&#x27; . __( &#x27;Delete Topic&#x27;, &#x27;buddypress&#x27; ) . &#x27;&lt;/a&gt;&lt;/li&gt;&#x27;;

        }

      }

      $links = apply_filters( &#x27;flawless::bp_navbar::topic_links&#x27;, $links );

      if ( empty( $links ) ) {
        return;
      }

      ?&gt;
      &lt;li class=&quot;dropdown&quot;&gt;
        &lt;a href=&quot;&lt;?php echo admin_url(); ?&gt;&quot; class=&quot;dropdown-toggle&quot;
           data-toggle=&quot;dropdown&quot;&gt;&lt;?php _e( &#x27;Topic&#x27;, &#x27;flawless&#x27; ); ?&gt;&lt;b class=&quot;caret&quot;&gt;&lt;/b&gt;&lt;/a&gt;
        &lt;ul class=&quot;dropdown-menu&quot;&gt;&lt;?php echo implode( &#x27;&#x27;, (array)$links ); ?&gt;&lt;/ul&gt;
      &lt;/li&gt;
    &lt;?php

    }

    /**
     * Add BuddyPress forum topics to Google XML Sitemaps
     *
     * @author potanin@UD
     */
    function sm_buildmap() {

      $generatorObject = &amp; GoogleSitemapGenerator::GetInstance();

      if ( !$generatorObject ) {
        return;
      }

      //** Load topics into $forum_template */
      bp_has_forum_topics( array( &#x27;per_page&#x27; =&gt; -1 ) );

      while ( bp_forum_topics() ) {
        bp_the_forum_topic();
        $generatorObject-&gt;AddUrl( bp_get_the_topic_permalink(), time(), &#x27;daily&#x27;, 0.5 );
      }

    }

    /**
     * Adds BuddyPress class to body tag
     *
     * @author potanin@UD
     */
    function body_class( $classes ) {
      return $classes;
    }

    /**
     * Force Flawless template_redirect to be loaded in BuddyPress
     *
     * @author potanin@UD
     */
    function bp_load_template( $located_template ) {
      global $wp_query;

      Flawless::console_log( sprintf( __( &#x27;Executing: %1s.&#x27;, &#x27;wp_crm&#x27; ), &#x27;Flawless_BuddyPress::bp_load_template()&#x27; ) );

      Flawless::template_redirect();

      return $located_template;
    }

    /**
     * Force Flawless template_redirect to be loaded in BuddyPress
     *
     * @author potanin@UD
     */
    function widgets_init( $sidebars ) {

      register_sidebar( array(
        &#x27;name&#x27; =&gt; &#x27;BuddyPress Sidebar&#x27;,
        &#x27;id&#x27; =&gt; &#x27;buddypress_sidebar&#x27;,
        &#x27;description&#x27; =&gt; __( &#x27;The sidebar widget area displayed on BuddyPress pages.&#x27;, &#x27;flawless&#x27; ),
        &#x27;before_widget&#x27; =&gt; &#x27;&lt;div id=&quot;%1$s&quot; class=&quot;widget %2$s&quot;&gt;&#x27;,
        &#x27;after_widget&#x27; =&gt; &#x27;&lt;/div&gt;&#x27;,
        &#x27;before_title&#x27; =&gt; &#x27;&lt;h3 class=&quot;widgettitle&quot;&gt;&#x27;,
        &#x27;after_title&#x27; =&gt; &#x27;&lt;/h3&gt;&#x27;
      ) );

    }

    /**
     * Determine if BP Template plugin is used
     * and disable all CSS and JS/AJAX functionality of it.
     *
     * Also adds admin notice about it.
     *
     * @author Maxim Peshkov
     */
    function check_for_bp_template_pack() {
      if ( function_exists( &#x27;bp_tpack_loader&#x27; ) ) {
        /** Disable BP Template Pack JS / AJAX */
        if ( !get_option( &#x27;bp_tpack_disable_js&#x27; ) ) {
          add_option( &#x27;bp_tpack_disable_js&#x27;, 1 );
        }
        /** Disable BP Template Pack CSS */
        if ( !get_option( &#x27;bp_tpack_disable_css&#x27; ) ) {
          add_option( &#x27;bp_tpack_disable_css&#x27;, 1 );
        }
        add_action( &#x27;admin_notices&#x27;, array( &#x27;Flawless_BuddyPress&#x27;, &#x27;bp_template_pack_admin_notices&#x27; ) );
      }
    }

    /**
     * Renders admin notice about incompatibility of BP Template plugin
     * with the Flawless theme
     *
     * @author Maxim Peshkov
     */
    function bp_template_pack_admin_notices() {
      ?&gt;
      &lt;div class=&quot;error&quot;&gt;
        &lt;p&gt;&lt;?php _e( &quot;You&#x27;re using &lt;b&gt;BP Template Pack&lt;/b&gt; which can cause CSS and JS conflicts with &lt;b&gt;Flawless&lt;/b&gt; theme. Actually, Flawless theme supports BuddyPress functionality and has own set of CSS Styles and JS. You should deactivate or remove your &lt;b&gt;BP Template Pack&lt;/b&gt; &lt;a href=\&quot;&quot; . admin_url( &#x27;plugins.php&#x27; ) . &quot;\&quot;&gt;here&lt;/a&gt;.&quot;, &#x27;flawless&#x27; ); ?&gt;&lt;/p&gt;
      &lt;/div&gt;
      &lt;?php
      return;
    }

    /**
     * Handles rendering of xprofile group tabs:
     * adds some bootstrap styles.
     *
     * @param array $tabs.
     * @param $groups.
     * @param string $group_name. Current active group.
     * @author peshkov@UD
     */
    function profile_group_tabs( $tabs, $groups, $group_name ) {
      foreach ( $tabs as &amp;$tab ) {
        if ( strpos( $tab, $group_name ) !== false ) {
          $tab = str_replace( &#x27;current&#x27;, &#x27;active&#x27;, $tab );
        }
      }
      return $tabs;
    }

  }

  //** All BuddyPress actions are initialized after bb_include action is ran. */
  add_action( &#x27;Flawless_setup&#x27;, array( &#x27;BuddyPress&#x27;, &#x27;Flawless_setup&#x27; ) );

}

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
