<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>modules/less/less.php - Flawless</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="http://a3d72a45d111006ec192-ec5b80a12b0b09b4d52373336afb4254.r80.cf1.rackcdn.com/usability-dynamics.png" title="Flawless"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.1.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/: Flawless.Element.html">: Flawless.Element</a></li>
            
                <li><a href="../classes/: Flawless.Flawless_Module.html">: Flawless.Flawless_Module</a></li>
            
                <li><a href="../classes/: Flawless.Flawless_Shortcode.html">: Flawless.Flawless_Shortcode</a></li>
            
                <li><a href="../classes/: Flawless.Flawless_Widget.html">: Flawless.Flawless_Widget</a></li>
            
                <li><a href="../classes/: Flawless.flawless_wpp_extensions.html">: Flawless.flawless_wpp_extensions</a></li>
            
                <li><a href="../classes/: Flawless.License.html">: Flawless.License</a></li>
            
                <li><a href="../classes/Shortcodes.html">Shortcodes</a></li>
            
                <li><a href="../classes/Template Functions.html">Template Functions</a></li>
            
                <li><a href="../classes/Template Methods.html">Template Methods</a></li>
            
                <li><a href="../classes/Theme UI.html">Theme UI</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/Core Assets.html">Core Assets</a></li>
            
                <li><a href="../modules/Flawless.html">Flawless</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: modules/less/less.php</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&lt;?php
/**
 * Name: Flawless LESS Handler
 * Version: 1.0
 * Description: Extends lessphp.
 * Author: Usability Dynamics, Inc.
 * Theme Feature: less-css
 *
 *
 * =Documentation=
 * If the feature is enabled, on every page load the Flawless::build_compiled_css() is called which in turn calls flawless_class,
 * which processes /less/bootstrap.less, files references form within, as well as all enqueued front-end CSS files.
 * A reference to all includes files is saved in option &quot;flawless::compiled_css_files&quot;
 *
 * If one of the files has a a newer modification time than the compiled CSS files, then the compiled file is re-generated.
 * which are saved to the stylesheet directory, which is either the child theme, or the parent theme.
 *
 * When succssful, Flawless generates two files, bootstrap-compiled.css and bootstrap-compiled.min.css.
 *
 * =Developer Notes=
 * The file checking occurs at the wp_print_styles (0) action, since all the enqued styles must be known at that point.
 *
 * $flawless[ &#x27;_bootstrap_compiled_url&#x27; ] - URL to compiled CSS file.
 * $flawless[ &#x27;_bootstrap_compiled_path&#x27; ] - URL to compiled CSS file.
 * $flawless[ &#x27;_bootstrap_compiled_minified_path&#x27; ] - File path to minified compiled CSS file
 * $flawless[ &#x27;_bootstrap_compiled_minified_url&#x27; ] - URL to minified CSS file.
 *
 */

Flawless::load( &#x27;lessc.inc&#x27; );

if ( !class_exists( &#x27;lessc&#x27; ) ) {
  return;
}

class Flawless_LESS extends lessc {

  /**
   * Initializer.
   *
   * @since Flawless 0.6.1
   */
  function __construct() {

    //** On initial call, we need to initialize the feature via hooks */
    if ( !did_action( &#x27;flawless::available_theme_features&#x27; ) ) {
      return Flawless_LESS::initialize();
    }

  }

  /**
   * Generates a compiled CSS file from multiple CSS and LESS files
   *
   * @since 0.0.3
   */
  function build_compiled_css( $styles, $args = array() ) {
    global $flawless;

    $args = wp_parse_args( $args, array(
      &#x27;minified_output_path&#x27; =&gt; $flawless[ &#x27;_bootstrap_compiled_minified_path&#x27; ],
      &#x27;output_path&#x27; =&gt; $flawless[ &#x27;_bootstrap_compiled_path&#x27; ]
    ));

    //** We do not ensure that feature is supported, but the class is required */
    if ( !class_exists( &#x27;Flawless_LESS&#x27; ) ) {
      //return new WP_Error( &#x27;error&#x27;, Flawless::console_log( sprintf( __( &#x27;CSS Compiling Error: Library not found.&#x27;, &#x27;flawless&#x27; ) ), &#x27;error&#x27; ));
    }

    //** Verify that the target directory is writable.
    if ( !is_writable( dirname( $flawless[ &#x27;_bootstrap_compiled_minified_path&#x27; ] ) ) ) {
      return new WP_Error( &#x27;error&#x27;, Flawless::console_log( sprintf( __( &#x27;CSS Compiling Error: Directory %1s is not writable&#x27;, &#x27;flawless&#x27; ), dirname( $flawless[ &#x27;_bootstrap_compiled_minified_path&#x27; ] ) ), &#x27;error&#x27; ));
    }

    foreach ( (array) $styles as $handle =&gt; $style_data ) {
      $_handles[ ] = dirname( $style_data[ &#x27;path&#x27; ] ) . &#x27;/&#x27; . $style_data[ &#x27;file_name&#x27; ];
      $_paths[ ] = $style_data[ &#x27;path&#x27; ];
    }

    if ( empty( $_handles ) ) {
      return;
    }

    //$_Flawless_LESS = new Flawless_LESS();

    //** Cycle through each CSS file and check for validation */
    foreach ( (array) $_paths as $path ) {
      //if ( is_wp_error( $_validation = $_Flawless_LESS-&gt;compile( $path ) ) ) {
      // $_validation_errors[ ] = $path . &#x27; - &#x27; . $_validation-&gt;get_error_message();
      //}
    }

    if ( $_validation_errors &amp;&amp; is_array( $_validation_errors ) &amp;&amp; count( $_validation_errors ) &gt; 0 ) {
      return new WP_Error( &#x27;compile_error&#x27;, Flawless::console_log( sprintf( __( &#x27;CSS Compiling Errors:&lt;br /&gt; %1s &#x27;, &#x27;flawless&#x27; ), implode( &#x27;&lt;br /&gt;&#x27;, $_validation_errors ) ), &#x27;error&#x27; ));
    }

    //** Pass CSS array for real complication. */
    //if ( is_wp_error( $output = $_Flawless_LESS-&gt;compile( $_paths ) ) ) {
    //return new WP_Error( &#x27;compile_error&#x27;, Flawless::console_log( sprintf( __( &#x27;LESS Compiling Error: %1s &#x27;, &#x27;flawless&#x27; ), $output-&gt;get_error_message() ), &#x27;error&#x27; ));
    //}

    $_header = apply_filters( &#x27;flawless::compiled_css::css_header&#x27;, array(
      &#x27;/**&#x27;,
      &#x27; * Name: &#x27; . get_bloginfo() . &#x27; Screen Styles&#x27;,
      &#x27; * Generated: &#x27; . date( get_option( &#x27;date_format&#x27; ) ) . &#x27; at &#x27; . date( get_option( &#x27;time_format&#x27; ) ),
      &#x27; * Compilation Time: &#x27; . round( timer_stop() ) . &#x27; seconds&#x27;,
      &#x27; * Source Files: &#x27;,
      &#x27; * - &#x27; . implode( &quot; \n * - &quot;, (array) $_handles ),
      &#x27; * &#x27;,
      &#x27; */&#x27;
    ));

    if ( empty( $output[ &#x27;parsed&#x27; ] ) ) {
      //return new WP_Error( &#x27;compile_error&#x27;, Flawless::console_log( sprintf( __( &#x27;CSS Compiling Error: Compiled file empty after attempting to compile (%1s) CSS files.&#x27;, &#x27;flawless&#x27; ), count( (array) $_handles ) ), &#x27;error&#x27; ));
    }

    //** @todo Is there a way to catch warnings? - potanin@UD 6/10/12 */
    if ( WP_DEBUG ) {
      file_put_contents( $args[ &#x27;output_path&#x27; ], implode( &quot;\n&quot;, (array) $_header ) . &quot;\n\n&quot; . $output[ &#x27;parsed&#x27; ] );
      file_put_contents( $args[ &#x27;minified_output_path&#x27; ], $output[ &#x27;minified&#x27; ] );
    } else {
      @file_put_contents( $args[ &#x27;output_path&#x27; ], implode( &quot;\n&quot;, (array) $_header ) . &quot;\n\n&quot; . $output[ &#x27;parsed&#x27; ] );
      @file_put_contents( $args[ &#x27;minified_output_path&#x27; ], $output[ &#x27;minified&#x27; ] );
    }

    if ( !file_exists( $args[ &#x27;minified_output_path&#x27; ] ) ) {
      return new WP_Error( &#x27;saving_error&#x27;, Flawless::console_log( sprintf( __( &#x27;CSS Compiling Error: Compiled file (%1s) could not be saved to disk.&#x27;, &#x27;flawless&#x27; ), $args[ &#x27;minified_output_path&#x27; ] ), &#x27;error&#x27; ));
    }

    Flawless::console_log( sprintf( __( &#x27;CSS Compiling: - Compiled file created from (%1s) files. Minified version is %2s and the uncompressed version is %3s.&#x27;, &#x27;flawless&#x27; ), count( $_handles ), self::format_bytes( filesize( $args[ &#x27;output_path&#x27; ] ) ), self::format_bytes( filesize( $args[ &#x27;minified_output_path&#x27; ] ) ) ));

    update_option( &#x27;flawless::compiled_css_files&#x27;, $styles );

    return true;

  }

  /**
   * Feature Initializer
   *
   * @since Flawless 0.6.1
   */
  function initialize() {

    /**
     * Add Frontend Editor as a Theme Feature. If already declared as Available Theme Feature, the exiting value takes presedence.
     *
     * @since Flawless 0.6.1
     */
    add_filter( &#x27;flawless::available_theme_features&#x27;, function ( $features ) {
      return array_merge( array( &#x27;less-css&#x27; =&gt; true ), (array)$features );
    } );

    /**
     * {missing description}
     *
     * @todo admin_bar_menu should be using Flawless::add_to_navbar() which should then add the Editor link to the appropriate Navbar. - potanin@UD 6/9/2012
     * @since Flawless 0.6.1
     */
    add_action( &#x27;flawless::theme_setup::after&#x27;, function () {

      if ( !current_theme_supports( &#x27;less-css&#x27; ) ) {
        return;
      }

    }, 200 );

  }

  /**
   * Compile LESS
   *
   * @param $paths
   * @param array $args
   * @return string|WP_Error
   */
  public function compile( $paths, $args = array() ) {
    global $flawless;

    $args = wp_parse_args( $form_data, array(
      &#x27;formatter&#x27; =&gt; false,
      &#x27;debug&#x27; =&gt; WP_DEBUG,
      &#x27;tidy&#x27; =&gt; true,
      &#x27;minify&#x27; =&gt; true
    ) );

    foreach ( (array)$paths as $path ) {
      $_contents .= file_get_contents( $path );
    }

    try {
      $_less = new lessc();

      $_less-&gt;importDir[ ] = untrailingslashit( get_stylesheet_directory() ) . &#x27;/less&#x27;;
      $_less-&gt;importDir[ ] = untrailingslashit( get_template_directory() ) . &#x27;/less&#x27;;
      $_less-&gt;importDir[ ] = untrailingslashit( get_stylesheet_directory() ) . &#x27;/css&#x27;;
      $_less-&gt;importDir[ ] = untrailingslashit( get_template_directory() ) . &#x27;/css&#x27;;

      if ( $args[ &#x27;formatter&#x27; ] ) {
        $_less-&gt;setFormatter( $args[ &#x27;formatter&#x27; ] );
      }

      foreach ( (array)$flawless[ &#x27;css_options&#x27; ] as $name =&gt; $option ) {
        $_less_variables[ &#x27;@&#x27; . $name ] = $option[ &#x27;value&#x27; ] . &#x27;;&#x27;;
      }

      if ( $args[ &#x27;debug&#x27; ] ) {
        $code[ &#x27;parsed&#x27; ] = $_less-&gt;parse( $_contents, $_less_variables );
      } else {
        $code[ &#x27;parsed&#x27; ] = @$_less-&gt;parse( $_contents, $_less_variables );
      }

    } catch ( exception $ex ) {
      return new WP_Error( &#x27;compile_error&#x27;, $ex-&gt;getMessage() );
    }

    if ( $args[ &#x27;tidy&#x27; ] &amp;&amp; ( class_exists( &#x27;csstidy&#x27; ) || file_exists( untrailingslashit( get_template_directory() ) . &#x27;/core/libs/csstidy/class.csstidy.php&#x27; ) ) ) {

      include_once untrailingslashit( get_template_directory() ) . &#x27;/core/libs/csstidy/class.csstidy.php&#x27;;

      if ( class_exists( &#x27;csstidy&#x27; ) ) {
        $css = new csstidy();
        $css-&gt;load_template( untrailingslashit( get_template_directory() ) . &#x27;/core/libs/csstidy/template.tpl&#x27; );
        $data = $css-&gt;parse( $code[ &#x27;parsed&#x27; ] );
        $code[ &#x27;formatted&#x27; ] = $css-&gt;print-&gt;plain();
      }
    }

    if ( $args[ &#x27;minify&#x27; ] &amp;&amp; ( class_exists( &#x27;CssMin&#x27; ) || Flawless::load( &#x27;CssMin&#x27; ) ) ) {
      $code[ &#x27;minified&#x27; ] = CssMin::minify( $code[ &#x27;parsed&#x27; ] );
    }

    return $code;

  }

}

$Flawless_LESS = new Flawless_LESS();
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
