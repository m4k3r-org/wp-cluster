<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>core/premium/carrington-build/carrington-build.php - Flawless</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="http://a3d72a45d111006ec192-ec5b80a12b0b09b4d52373336afb4254.r80.cf1.rackcdn.com/usability-dynamics.png" title="Flawless"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.1.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/flawless_wpp_extensions.html">flawless_wpp_extensions</a></li>
            
                <li><a href="../classes/Loader.html">Loader</a></li>
            
                <li><a href="../classes/Shortcodes.html">Shortcodes</a></li>
            
                <li><a href="../classes/Template Functions.html">Template Functions</a></li>
            
                <li><a href="../classes/Theme UI.html">Theme UI</a></li>
            
                <li><a href="../classes/UD_API.html">UD_API</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/Core Assets.html">Core Assets</a></li>
            
                <li><a href="../modules/Flawless.html">Flawless</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: core/premium/carrington-build/carrington-build.php</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&lt;?php
/**
 * Name: Carrington Build Framework
 * Description: Extra functionality for Carrington Build.
 * Author: Usability Dynamics, Inc., Crowd Favorite
 * Version: 1.1
 *
 */


/**
 * Easy way of adding custom styles to Carrington Build Module style selector
 *
 * Type Options:
 *  - cfct_module_rich_text
 *  - cfct_module_callout
 *  - cfct_module_heading
 *  - cfct_module_loop_subpages
 *
 * @todo Add check to make sure image file exists
 * @return string HTML
 */
function add_cb_module_style( $class = false, $image_path = &#x27;&#x27;, $type = &#x27;general&#x27; ) {

  if( !$image_path || !$class ) {
    return;
  }

  add_filter( &#x27;flawless_carrington_module_styles&#x27;, create_function( &#x27;$options, $type=&quot;&#x27; . $type . &#x27;&quot;, $image_path=&quot;&#x27; . $image_path . &#x27;&quot;, $class=&quot;&#x27; . $class . &#x27;&quot; &#x27;, &#x27;  $options[$type][$class] = $image_path;  return $options; &#x27; ) );

}


class flawless_carrington {

  /**
   * {}
   * @version 1.1
   */
  function __construct() {

    /**
      * Declare as theme feature
      *
      * @since Flawless 1.1
      */
    add_filter( &#x27;flawless::available_theme_features&#x27;, function( $features ) {
      return array_merge( array( &#x27;carrington_build&#x27; =&gt; true ), (array) $features );
    });

    /* Disable Carrington Taxonomy Landing Page plugin */
    define( &#x27;CFCT_BUILD_TAXONOMY_LANDING&#x27;, false );

    /**
     * Primary Carrington Build custom functionality loader ran on
     *
     * @author potanin@UD
     * @version 1.0
     */
    add_action( &#x27;flawless::theme_setup::after&#x27;, function() {

      if( !current_theme_supports( &#x27;carrington_build&#x27; ) ) {
        return;
      }

      add_action( &#x27;flawless::init_lower&#x27;, array( &#x27;flawless_carrington&#x27;, &#x27;flawless_init_lower&#x27; ), 0, 20 );
      add_action( &#x27;flawless::admin_init&#x27;, array( &#x27;flawless_carrington&#x27;, &#x27;admin_init&#x27; ) );
      add_action( &#x27;wp_print_styles&#x27;, array( &#x27;flawless_carrington&#x27;, &#x27;wp_print_styles&#x27; ) );

      add_filter( &#x27;flawless::body_class&#x27;, array( &#x27;flawless_carrington&#x27;, &#x27;body_class&#x27; ), 10, 2 );
      add_filter( &#x27;flawless::module_class&#x27;, array( &#x27;flawless_carrington&#x27;, &#x27;module_class&#x27; ) );

      //** Configure location */
      add_filter( &#x27;cfct-build-loc&#x27; ,array( &#x27;flawless_carrington&#x27;, &#x27;cfct_build_loc&#x27; ) );

      //** Include Carrington Build Framework */
      include_once trailingslashit( TEMPLATEPATH ) . &#x27;functions/carrington-build/carrington-build.php&#x27;;

      //** add extra directories to scan for modules */
      add_filter( &#x27;cfct-module-dirs&#x27;, array( &#x27;flawless_carrington&#x27;, &#x27;cfct_module_dirs&#x27; ) );

      add_filter( &#x27;cfct-build-display-class&#x27;, array( &#x27;flawless_carrington&#x27;, &#x27;cfct_build_display_class&#x27; ), 10, 4 );

      add_filter( &#x27;cfct-generated-row-classes&#x27;, array( &#x27;flawless_carrington&#x27;, &#x27;cfct_generated_row_classes&#x27; ), 10, 4 );

      add_filter( &#x27;cfct-block-c6-12-classes&#x27;, function( $classes ) { return array_merge( array( &#x27;span4&#x27;, &#x27;first&#x27; ), $classes ); }, 10, 2 );
      add_filter( &#x27;cfct-block-c6-34-classes&#x27;, function( $classes ) { return array_merge( array( &#x27;span4&#x27; ), $classes ); }, 10, 2 );
      add_filter( &#x27;cfct-block-c6-56-classes&#x27;, function( $classes ) { return array_merge( array( &#x27;span4&#x27;, &#x27;last&#x27; ), $classes ); }, 10, 2 );

      add_filter( &#x27;cfct-block-c6-123-classes&#x27;, function( $classes ) { return array_merge( array( &#x27;span6&#x27;, &#x27;first&#x27; ), $classes ); }, 10, 2 );
      add_filter( &#x27;cfct-block-c6-456-classes&#x27;, function( $classes ) { return array_merge( array( &#x27;span6&#x27;, &#x27;last&#x27; ), $classes ); }, 10, 2 );
      add_filter( &#x27;cfct-block-c4-12-classes&#x27;, function( $classes ) { return array_merge( array( &#x27;span6&#x27;, &#x27;first&#x27; ), $classes ); }, 10, 2 );
      add_filter( &#x27;cfct-block-c4-34-classes&#x27;, function( $classes ) { return array_merge( array( &#x27;span6&#x27;, &#x27;last&#x27; ), $classes ); }, 10, 2 );

      add_filter( &#x27;cfct-block-c6-1234-classes&#x27;, function( $classes ) { return array_merge( array( &#x27;span8&#x27;, &#x27;first&#x27; ), $classes ); }, 10, 2 );
      add_filter( &#x27;cfct-block-c6-3456-classes&#x27;, function( $classes ) { return array_merge( array( &#x27;span8&#x27;, &#x27;last&#x27; ), $classes ); }, 10, 2 );

      add_filter( &#x27;cfct-block-c6-123456-classes&#x27;, function( $classes ) { return array_merge( array( &#x27;span12&#x27;, &#x27;first&#x27;, &#x27;full-width&#x27; ), $classes ); }, 10, 2 );
      add_filter( &#x27;cfct-block-c4-1234-classes&#x27;, function( $classes ) { return array_merge( array( &#x27;span12&#x27;, &#x27;first&#x27;, &#x27;full-width&#x27; ), $classes ); }, 10, 2 );

      add_filter( &#x27;cfct-build-module-class&#x27;, array( &#x27;flawless_carrington&#x27;, &#x27;cfct_module_wrapper_classes&#x27; ) , 10, 2 );

      add_filter( &#x27;cfct-row-admin-html&#x27;, array( &#x27;flawless_carrington&#x27;, &#x27;cfct_row_admin_html&#x27; ), 10, 4 );
      add_filter( &#x27;cfct-row-html&#x27;, array( &#x27;flawless_carrington&#x27;, &#x27;cfct_row_html&#x27; ), 10, 4 );

      add_filter( &#x27;cfct-module-cfct-callout-admin-form&#x27;, array( &#x27;flawless_carrington&#x27;, &#x27;cfct_module_admin_theme_chooser&#x27; ) , 10, 2 );
      add_filter( &#x27;cfct-module-cf-post-callout-module-admin-form&#x27;, array( &#x27;flawless_carrington&#x27;, &#x27;cfct_module_admin_theme_chooser&#x27; ) , 10, 2 );
      add_filter( &#x27;cfct-module-cfct-heading-admin-form&#x27;, array( &#x27;flawless_carrington&#x27;, &#x27;cfct_module_admin_theme_chooser&#x27; ) , 10, 2 );
      add_filter( &#x27;cfct-module-cfct-plain-text-admin-form&#x27;, array( &#x27;flawless_carrington&#x27;, &#x27;cfct_module_admin_theme_chooser&#x27; ) , 10, 2 );
      add_filter( &#x27;cfct-module-cfct-rich-text-admin-form&#x27;, array( &#x27;flawless_carrington&#x27;, &#x27;cfct_module_admin_theme_chooser&#x27; ) , 10, 2 );
      add_filter( &#x27;cfct-module-cfct-module-loop-admin-form&#x27;, array( &#x27;flawless_carrington&#x27;, &#x27;cfct_module_admin_theme_chooser&#x27; ) , 10, 2 );
      add_filter( &#x27;cfct-module-cfct-module-loop-subpages-admin-form&#x27;, array( &#x27;flawless_carrington&#x27;, &#x27;cfct_module_admin_theme_chooser&#x27; ) , 10, 2 );
      add_filter( &#x27;cfct-module-display&#x27;, array( &#x27;flawless_carrington&#x27;, &#x27;cfct_module_display&#x27; ) , 10, 3 );
      add_filter( &#x27;cfct-build-module-url-unknown&#x27;, array( &#x27;flawless_carrington&#x27;, &#x27;module_url_unknown&#x27; ) , 10, 3 );

      add_filter( &#x27;cfct-get-extras-modules-css-admin&#x27;, array( &#x27;flawless_carrington&#x27;, &#x27;cfct_module_admin_theme_chooser_css&#x27; ) , 10, 1 );
      add_filter( &#x27;cfct-get-extras-modules-js-admin&#x27;, array( &#x27;flawless_carrington&#x27;, &#x27;cfct_module_admin_theme_chooser_js&#x27; ) , 10, 1 );

      add_action( &#x27;cfct-widget-module-registered&#x27;, array( &#x27;flawless_carrington&#x27;, &#x27;cfct_widget_modules_register_theme_admin_form&#x27; ) , 10, 2 );

      add_action( &#x27;wp_footer&#x27;, array( &#x27;flawless_carrington&#x27;, &#x27;wp_print_footer_scripts&#x27; ) );

      /* Modify Loaded moodules */
      add_action( &#x27;cfct-modules-included&#x27;, array( &#x27;flawless_carrington&#x27;, &#x27;remove_loop_module&#x27; ) );

      if( $flawless[ &#x27;carrington_build&#x27; ][ &#x27;enable_build_templates&#x27; ] == &#x27;true&#x27; ) {
        define( &#x27;CFCT_BUILD_ENABLE_TEMPLATES&#x27;, true );
      }

    }, 200 );

  }


  /**
   * Primary Carrington Build custom functionality loader ran on
   *
   * @action flawless::init_lower (20), init (500)
   * @author potanin@UD
   * @version 1.0
   */
  function flawless_init_lower() {
    global $flawless;

    add_action( &#x27;cfct-build-enabled-post-types&#x27;, array( &#x27;flawless_carrington&#x27;, &#x27;add_custom_post_types&#x27; ) );

    //** Add option to enable Carrington Build on custom post types */
    add_action( &#x27;flawless_post_types_advanced_options&#x27;, array( &#x27;flawless_carrington&#x27;, &#x27;flawless_post_types_advanced_options&#x27; ) );

    //** Functionality for exporting/importing CB layouts */
    add_action( &#x27;wp_ajax_cbc_get_page_build&#x27;, create_function( &#x27;&#x27;, &#x27; die( flawless_carrington::get_page_build( $_REQUEST[\&#x27;post_id\&#x27; ] ) ); &#x27; ) );
    add_action( &#x27;wp_ajax_cbc_insert_page_build&#x27;, create_function( &#x27;&#x27;, &#x27;die( flawless_carrington::insert_page_build( $_REQUEST[\&#x27;post_id\&#x27; ], $_REQUEST[\&#x27;post_data\&#x27; ] ) ); &#x27; ) );
    add_action( &#x27;wp_ajax_flawless_cb_row_class&#x27;, array( &#x27;flawless_carrington&#x27;, &#x27;flawless_cb_row_class&#x27; ) );
    add_action( &#x27;wp_ajax_flawless_cb_build_class&#x27;, array( &#x27;flawless_carrington&#x27;, &#x27;flawless_cb_build_class&#x27; ) );

    if( $flawless[ &#x27;carrington_build&#x27; ][ &#x27;enable_tabbed_modules&#x27; ] == &#x27;true&#x27; ) {
      add_action( &#x27;wp_ajax_flawless_cb_save_tabbed_blocks&#x27;, array( &#x27;flawless_carrington&#x27;, &#x27;flawless_cb_save_tabbed_blocks&#x27; ) );
    }

    //** Enable Tabbed Modules */
    wp_register_script( &#x27;flawless-admin-cb_tabbed_modules&#x27;,  get_bloginfo( &#x27;template_url&#x27; ) . &#x27;/js/flawless.admin.cb_tabbed_modules.js&#x27;, array( &#x27;flawless-admin-global&#x27;, &#x27;jquery-ui-tabs&#x27; ), Flawless_Version, true );
    wp_register_style( &#x27;flawless-admin-cb_tabbed_modules&#x27;,  get_bloginfo( &#x27;template_url&#x27; ) . &#x27;/css/flawless.admin.cb_tabbed_modules.css&#x27;, array(), Flawless_Version, &#x27;screen&#x27; );

    add_cb_module_style( &#x27;enable-masonry&#x27;, get_template_directory_uri() . &#x27;/img/styles/enable-masonry.png&#x27; );

    //** Add extra CSS class for improved specificity */
    add_filter( &#x27;cfct-carousel-js-options&#x27;, function( $car_opts ) {
      $car_opts[ &#x27;prev&#x27; ] = &#x27;$(\&#x27;&lt;a class=&quot;left carousel-control cfct-carousel-prev&quot; data-slide=&quot;prev&quot;&gt;&amp;lsaquo;&lt;/a&gt;\&#x27;).appendTo( jQuery(&#x27;.$car_opts[&#x27;pager&#x27;].&#x27;).closest( &quot;.carousel-inner&quot; ) )&#x27;;
      $car_opts[ &#x27;next&#x27; ] = &#x27;$(\&#x27;&lt;a class=&quot;right carousel-control cfct-carousel-next&quot; data-slide=&quot;next&quot;&gt;&amp;rsaquo;&lt;/a&gt;\&#x27;).appendTo(  jQuery(&#x27;.$car_opts[&#x27;pager&#x27;].&#x27;).closest( &quot;.carousel-inner&quot; ) )&#x27;;
      $car_opts[ &#x27;pager&#x27; ] = &#x27;false&#x27;;
      return $car_opts;
    });

    //** Add extra CSS class for improved specificity */
    add_filter( &#x27;cfct-carousel-nav-element&#x27;, function( $html ) {
      return &#x27;&lt;div class=&quot;car-pagination&quot;&gt;&lt;ol class=&quot;pagination-buttons&quot;&gt;&lt;/ol&gt;&lt;/div&gt;&#x27;;
    });

    //** Remove fixed height and width so we can be responsive */
    add_filter( &#x27;cfct-carousel-js-init&#x27;, function( $html, $module_id,  $car_opts, $js_opts ) {
      return $html . &#x27;&lt;script type=&quot;text/javascript&quot;&gt;jQuery( window ).load( function() { if( jQuery( &quot;#carousel-&#x27;.$module_id.&#x27; .car-content ul&quot; ).height() === 0 ) { jQuery( &quot;#carousel-&#x27;.$module_id.&#x27; .car-content ul&quot; ).css( &quot;height&quot;, &quot;auto&quot; ).css( &quot;width&quot;, &quot;&quot; ); } });&lt;/script&gt;&#x27;;
    }, 10, 4 );

    //** Carousel: Add option to not use any pagination */
    add_filter( &#x27;cfct-carousel-nav-positions&#x27;, function( $positions ) {
      return array_merge( array( &#x27;none&#x27; =&gt; &#x27;None&#x27; ), $positions );
    });

  }


  /**
   * Make sure we check for situations when WP_CONTENT_DIR is changed.
   *
   * This fixes a CB bug.
   *
   * @author potanin@UD
   */
  function module_url_unknown( $url, $module, $file_key ) {
    return trailingslashit( str_replace( WP_CONTENT_DIR, WP_CONTENT_URL, $module) );
  }



  /**
   * Having CB Scan theme/modules and child-theme/modules for additional modules.
   *
   * @author potanin@UD
   */
  function cfct_module_dirs( $dirs ) {
    global $flawless;

    foreach( (array) $flawless[ &#x27;asset_directories&#x27; ] as $path =&gt; $url ) {
      $dirs[] = $path . &#x27;/modules&#x27;;
    }

    return $dirs;

  }


  /**
   * Footer scripts on front-end.  Also for debugging.
   *
   * @author potanin@UD
   */
  function wp_print_footer_scripts() {
    global $post, $flawless;

    if( $flawless[ &#x27;developer_mode&#x27; ] != &#x27;true&#x27; ) {
      return;
    }

    $_cfct_build_data = get_post_meta( $post-&gt;ID, &#x27;_cfct_build_data&#x27;, true );

  }


  /**
   * Deregister Modules
   *
   * @action
   * @author potanin@UD
   * @version 1.0
   */
  function remove_loop_module() {

    /* Deregister Loop - UD Loop will be used instead */
    cfct_build_deregister_module( &#x27;cfct_module_loop&#x27; );

  }


  /**
   * Back-end CB settings
   *
   * @author potanin@UD
   * @version 1.0
   */
  function admin_init() {

    add_action( &#x27;flawless::options_ui_general::common_settings&#x27;, array( &#x27;flawless_carrington&#x27;, &#x27;options_ui_general_common_settings&#x27; ), 200 );

    //** Load back-end JS  */
    add_action( &#x27;admin_enqueue_scripts&#x27;, array( &#x27;flawless_carrington&#x27;, &#x27;admin_enqueue_scripts&#x27; ), 10 );

    //** Carrington Build Mods ( Export / Import layouts ) */
    add_filter( &#x27;cfct-build-page-options&#x27;, array( &#x27;flawless_carrington&#x27;, &#x27;cfct_build_page_options&#x27; ) );
    add_filter( &#x27;cfct-admin-pre-build&#x27;, array( &#x27;flawless_carrington&#x27;, &#x27;cfct_admin_pre_build&#x27; ) );

  }


  /**
   * Add CB options to Settings page.
   *
   * @action flawless::options_ui_general::common_settings ( 200 )
   * @author potanin@UD
   */
  function options_ui_general_common_settings( $flawless ) { ?&gt;
    &lt;li&gt;&lt;label&gt;&lt;input type=&quot;checkbox&quot; &lt;?php echo checked( &#x27;true&#x27;, $flawless[ &#x27;carrington_build&#x27; ][ &#x27;enable_tabbed_modules&#x27; ] ); ?&gt; name=&quot;flawless_settings[carrington_build][enable_tabbed_modules]&quot; value=&quot;true&quot; /&gt; &lt;?php _e( &#x27;Enable Tabbed Modules in Carrington Build.&#x27;, &#x27;flawless&#x27; ); ?&gt;&lt;/label&gt;&lt;/li&gt;
    &lt;li&gt;&lt;label&gt;&lt;input type=&quot;checkbox&quot; &lt;?php echo checked( &#x27;true&#x27;, $flawless[ &#x27;carrington_build&#x27; ][ &#x27;enable_build_templates&#x27; ] ); ?&gt; name=&quot;flawless_settings[carrington_build][enable_build_templates]&quot; value=&quot;true&quot; /&gt; &lt;?php _e( &#x27;Enable Carrington Build Templates.&#x27;, &#x27;flawless&#x27; ); ?&gt;&lt;/label&gt;&lt;/li&gt;

    &lt;?php
  }


  /**
   * Include admin scripts and styles
   *
   * @author potanin@UD
   */
  function admin_enqueue_scripts() {
    global $flawless;

    if( $flawless[ &#x27;carrington_build&#x27; ][ &#x27;enable_tabbed_modules&#x27; ] == &#x27;true&#x27; ) {
      wp_enqueue_script( &#x27;flawless-admin-cb_tabbed_modules&#x27; );
      wp_enqueue_style( &#x27;flawless-admin-cb_tabbed_modules&#x27; );
    }

  }


  /**
   * Setsup a global JS array with any Module Blocks that have tabs
   *
   * @author potanin@UD
   * @version 1.0
   */
  function cfct_admin_pre_build( $this_build ) {
    global $cfct_build, $post_id;

    $tabbed_blocks = $this_build-&gt;data[ &#x27;tabbed_blocks&#x27; ];

    if( empty( $tabbed_blocks ) ) {
      return;
    }

    echo &#x27;&lt;script type=&quot;text/javascript&quot;&gt;var cb_ud_tabbed_blocks = jQuery.parseJSON( &#x27; . json_encode( json_encode( $tabbed_blocks ) ) . &#x27; ); &lt;/script&gt;&#x27;;

  }


  /**
  * Style -&gt; image mapping for style chooser
  * @return array
  */
  function admin_theme_style_images( $type ) {

    $options[ &#x27;general&#x27; ] = array();

    $options[ &#x27;post_callout_module&#x27; ] = array();

    $options[ &#x27;cfct_module_callout&#x27; ] = array();

    $options = apply_filters( &#x27;flawless_carrington_module_styles&#x27;, $options );

    //** Merge General Styles into Post Callout Module */
    $options[ &#x27;post_callout_module&#x27; ] = array_merge( $options[ &#x27;post_callout_module&#x27; ], $options[ &#x27;general&#x27; ] );

    //** Merge Post Callout module ( and thus General styles ) into regular Callout */
    $options[ &#x27;cfct_module_callout&#x27; ] = array_merge( $options[ &#x27;cfct_module_callout&#x27; ], $options[ &#x27;post_callout_module&#x27; ] );

    Flawless::console_log( &#x27;P: admin_theme_style_images() for Module Type: &#x27; . $type );

    //** Return either a specific module style or general */
    $return = ( isset( $options[$type] ) ? $options[$type] : $options[ &#x27;general&#x27; ] );

    return $return;

  }


  /**
   * Common function for adding style chooser
   *
   * @param string $form_html - HTML of module admin form
   * @param array $data - form save data
   * @return string HTML
   */
  function cfct_module_admin_theme_chooser( $form_html, $data ) {

    $type = $data[ &#x27;module_type&#x27; ];
    $img_url_base = trailingslashit( get_template_directory_uri() );

    $style_image_config = flawless_carrington::admin_theme_style_images( $type );

    $selected = null;

    if ( !empty( $data[ &#x27;cfct-custom-theme-style&#x27; ] ) &amp;&amp; !empty( $style_image_config[$data[ &#x27;cfct-custom-theme-style&#x27; ]] ) ) {
      $selected = $data[ &#x27;cfct-custom-theme-style&#x27; ];
    }

    $onclick = &#x27;onclick=&quot;cfct_set_theme_choice( this ); return false;&quot;&#x27;;

    $form_html .= &#x27;
      &lt;fieldset class=&quot;cfct-custom-theme-style&quot;&gt;
        &lt;div id=&quot;cfct-custom-theme-style-chooser&quot; class=&quot;cfct-custom-theme-style-chooser cfct-image-select-b&quot;&gt;
          &lt;input type=&quot;hidden&quot; id=&quot;cfct-custom-theme-style&quot; class=&quot;cfct-custom-theme-style-input&quot; name=&quot;cfct-custom-theme-style&quot; value=&quot;&#x27;.( !empty( $data[ &#x27;cfct-custom-theme-style&#x27; ] ) ? esc_attr( $data[ &#x27;cfct-custom-theme-style&#x27; ] ) : &#x27;&#x27; ).&#x27;&quot; /&gt;

          &lt;label onclick=&quot;cfct_toggle_theme_chooser( this ); return false;&quot;&gt;Style&lt;/label&gt;
          &lt;div class=&quot;cfct-image-select-current-image cfct-image-select-items-list-item cfct-theme-style-chooser-current-image&quot; onclick=&quot;cfct_toggle_theme_chooser( this ); return false;&quot;&gt;&#x27;;

    if ( !empty( $selected ) &amp;&amp; !empty( $style_image_config[$selected] ) ) {
        $form_html .= &#x27;
            &lt;div class=&quot;cfct-image-select-items-list-item&quot;&gt;
              &lt;div class=&quot;test1&quot; style=&quot;background: #d2cfcf url( &#x27;.$style_image_config[$selected].&#x27; ) 0 0 no-repeat;&quot;&gt;&lt;/div&gt;
            &lt;/div&gt;&#x27;;

    } else {
      $form_html .= &#x27;
      &lt;div class=&quot;cfct-image-select-items-list-item&quot;&gt;&lt;div style=&quot;background: #d2cfcf url( &#x27;.$img_url_base.&#x27;functions/carrington-build/img/none-icon.png ) 50% 50% no-repeat;&quot;&gt;&lt;/div&gt;&lt;/div&gt;&#x27;;
    }

    $form_html .= &#x27;
      &lt;/div&gt;

      &lt;div class=&quot;clear&quot;&gt;&lt;/div&gt;

      &lt;div id=&quot;cfct-theme-select-images-wrapper&quot;&gt;
        &lt;h4&gt;&#x27;.__( &#x27;Select a style...&#x27;, &#x27;favebusiness&#x27; ).&#x27;&lt;/h4&gt;
        &lt;div class=&quot;cfct-image-select-items-list cfct-image-select-items-list-horizontal cfct-theme-select-items-list&quot;&gt;
          &lt;ul class=&quot;cfct-image-select-items&quot;&gt;
            &lt;li class=&quot;cfct-image-select-items-list-item &#x27;.( empty( $selected ) ? &#x27; active&#x27; : &#x27;&#x27; ).&#x27;&quot; data-image-id=&quot;0&quot; &#x27;.$onclick.&#x27;&gt;
              &lt;div style=&quot;background: #d2cfcf url( &#x27;.$img_url_base.&#x27;functions/carrington-build/img/none-icon.png ) no-repeat 50% 50%;&quot;&gt;&lt;/div&gt;
            &lt;/li&gt;&#x27;;

    foreach ( ( array ) $style_image_config as $style =&gt; $image ) {
      $form_html .= &#x27;&lt;li class=&quot;cfct-image-select-items-list-item&#x27;.( $selected == $style ? &#x27; active&#x27; : &#x27;&#x27; ).&#x27;&quot; data-image-id=&quot;&#x27;.$style.&#x27;&quot; &#x27;.$onclick.&#x27;&gt;
        &lt;div class=&quot;test2&quot; style=&quot;background: url( &#x27;.$image.&#x27; ) 0 0 no-repeat;&quot;&gt;&lt;/div&gt;
        &lt;/li&gt;&#x27;;
    }

    $form_html .=&#x27;
                &lt;/ul&gt;
              &lt;/div&gt;
            &lt;/div&gt;
          &lt;/div&gt;
        &lt;/fieldset&gt;
      &#x27;;

    return $form_html;
  }


  /**
   * Apply the custom theme style
   *
   * @param string $class_string - base module wrapper classes
   * @param array $data - module save data
   * @return string
   */
  function cfct_module_wrapper_classes( $class, $data ) {
    $type = $data[ &#x27;module_type&#x27; ];

    $classes = explode( &#x27; &#x27;, $class );

    if( $type == &#x27;cfct_module_notice&#x27; ) {
      $classes[] = &#x27;alert&#x27;;
    }

    // see if we have a custom theme style to apply
    if ( !empty( $data[ &#x27;cfct-custom-theme-style&#x27; ] ) ) {
      $classes[] = esc_attr( $data[ &#x27;cfct-custom-theme-style&#x27; ] );
    }

    $class = trim( implode( &#x27; &#x27;, $classes ) );

    return $class;
  }


  /**
   * JS for Theme Chooser in individual Module Admin Screens
   *
   * @param string $js
   * @return string
   */
  function cfct_module_admin_theme_chooser_js( $js ) {
    $js .= preg_replace( &#x27;/^( \t ){2}/m&#x27;, &#x27;&#x27;, &#x27;

      cfct_set_theme_choice = function( clicked ) {
        _this = $( clicked );
        _this.addClass( &quot;active&quot; ).siblings().removeClass( &quot;active&quot; );
        _wrapper = _this.parents( &quot;.cfct-custom-theme-style-chooser&quot; );
        _val = _this.attr( &quot;data-image-id&quot; );
        _background_pos = ( _val == &quot;0&quot; ? &quot;50% 50%&quot; : &quot;0 0&quot; );

        $( &quot;input:hidden&quot;, _wrapper ).val( _val );

        $( &quot;.cfct-image-select-current-image .cfct-image-select-items-list-item &gt; div&quot;, _wrapper )
          .css( {&quot;background-image&quot;: _this.children( &quot;:first&quot; ).css( &quot;backgroundImage&quot; ), &quot;background-position&quot;: _background_pos} );

        $( &quot;#cfct-theme-select-images-wrapper&quot; ).slideToggle( &quot;fast&quot; );
        return false;
      };

      cfct_toggle_theme_chooser = function( clicked ) {
        $( &quot;#cfct-theme-select-images-wrapper&quot; ).slideToggle( &quot;fast&quot; );
        return false;
      }

    &#x27; );
    return $js;
  }


  /**
   * CSS for Theme Chooser in individual Module Admin Screens
   *
   * @param string $css
   * @return string
   */
  function cfct_module_admin_theme_chooser_css( $css ) {
    $css .= preg_replace( &#x27;/^( \t ){2}/m&#x27;, &#x27;&#x27;, &#x27;
      /* Theme Chooser Additions */
      #cfct-custom-theme-style-chooser .cfct-image-select-current-image {
        display: block;
        height: 100px;
        width: auto;
      }
      #cfct-custom-theme-style-chooser .cfct-image-select-current-image p {
        text-align: left;
        font-size: 1em;
      }
      #cfct-custom-theme-style-chooser .cfct-image-select-current-image,
      #cfct-custom-theme-style-chooser .cfct-image-select-current-image&gt;div {
        cursor: pointer;
      }
      #cfct-custom-theme-style-chooser .cfct-image-select-current-image .cfct-image-select-items-list-item,
      #cfct-custom-theme-style-chooser .cfct-image-select-current-image .cfct-image-select-items-list-item&gt;div {
        height: 55px;
      }

      #cfct-custom-theme-style-chooser .cfct-theme-style-chooser-current-image {
        height: 75px;
      }
      #cfct-custom-theme-style-chooser label {
        float: left;
        display: block;
        width: 120px;
        margin-top: 25px;
      }
      #cfct-custom-theme-style-chooser #cfct-theme-select-images-wrapper {
        display: none;
      }
      .cfct-popup-content.cfct-popup-content-fullscreen fieldset.cfct-custom-theme-style {
        margin: 12px;
      }
      #cfct-theme-select-images-wrapper h4 {
        color: #666;
        font-weight: normal;
        margin: 0 0 5px;
      }
    &#x27; );
    return $css;
  }

  /**
   * Register a filter for each widget module loaded
   *
   * @param string $widget_id - standard wordpress widget_id
   * @param string $module_id - id of module in build
   * @return void
   */
  function cfct_widget_modules_register_theme_admin_form( $widget_id, $module_id ) {
    add_filter( &#x27;cfct-module-&#x27;.$module_id.&#x27;-admin-form&#x27;, array( &#x27;flawless_carrington&#x27;, &#x27;cfct_module_admin_theme_chooser&#x27; ) , 10, 2 );
  }


  /**
   * Load custom carrington CSS
   *
   */
  function wp_print_styles() {

    //** Always load bootstrap.css */
    if( Flawless::load( &#x27;carrington.css&#x27;, &#x27;css&#x27; ) ) {
      wp_enqueue_style( &#x27;flawless-carrington&#x27;, Flawless::load( &#x27;carrington.css&#x27;, &#x27;css&#x27; ), array( &#x27;flawless-style&#x27; ), Flawless_Version, &#x27;screen&#x27; );
    }

    //* dequeue carrington styles */
    wp_dequeue_style( &#x27;cfct-build-css-print&#x27; );
    wp_dequeue_style( &#x27;cfct-build-css&#x27; );

  }


  /**
   * Sets highest possible Carrington Build styles
   *
   * @todo &#x27;_cfct_build_data&#x27; may already be in a global variable and may not need to be loaded using gpm again
   * @author potanin@UD
   * @version 1.0
   */
  function cfct_build_display_class( $current ) {
    global $post;

    $cfct_data = get_post_meta( $post-&gt;ID, &#x27;_cfct_build_data&#x27;, true );

    $custom_class = !empty( $cfct_data[ &#x27;template&#x27; ][ &#x27;custom_class&#x27; ] ) ? $cfct_data[ &#x27;template&#x27; ][ &#x27;custom_class&#x27; ] : &#x27;cfct-build-default&#x27;;

    return $current . &#x27; &#x27; . $custom_class;
  }


  /**
   * Saves custom row class
   *
   * @author potanin@UD
   * @version 1.0
   */
  function flawless_cb_row_class() {

    $post_id = $_REQUEST[ &#x27;post_id&#x27; ];
    $row_id = $_REQUEST[ &#x27;row_id&#x27; ];
    $new_class = $_REQUEST[ &#x27;new_class&#x27; ];

    if( !$post_id || !is_numeric( $post_id ) ) {
      $response = array(
        &#x27;success&#x27; =&gt; &#x27;false&#x27;,
        &#x27;message&#x27; =&gt; __( &#x27;No post ID.&#x27;, &#x27;flawless&#x27; )
      );

    } else {

      $cfct_data = get_post_meta( $post_id, &#x27;_cfct_build_data&#x27;, true );
      $rows = $cfct_data[ &#x27;template&#x27; ][ &#x27;rows&#x27; ];

      foreach( ( array ) $rows as $row_guid =&gt; $row_data ) {

        if( $row_guid == $row_id ) {
          $cfct_data[ &#x27;template&#x27; ][ &#x27;rows&#x27; ][$row_guid][ &#x27;custom_class&#x27; ] = !empty( $new_class ) ? $new_class : &#x27;default-row-class&#x27;;
          continue;
        }

      }

      update_post_meta( $post_id, &#x27;_cfct_build_data&#x27;, $cfct_data );

      $response = array(
        &#x27;success&#x27; =&gt; &#x27;true&#x27;,
        &#x27;message&#x27; =&gt; __( &#x27;Custom row class saved.&#x27;, &#x27;flawless&#x27; ),
        &#x27;row_guid&#x27; =&gt; $row_guid
      );

    }

    die( json_encode( $response ) );
  }


  /**
   * Saves custom Build class
   *
   * @author potanin@UD
   * @version 1.0
   */
  function flawless_cb_build_class() {

    $post_id = $_REQUEST[ &#x27;post_id&#x27; ];
    $new_class = $_REQUEST[ &#x27;new_class&#x27; ];

    if( !$post_id || !is_numeric( $post_id ) ) {
      $response = array(
        &#x27;success&#x27; =&gt; &#x27;false&#x27;,
        &#x27;message&#x27; =&gt; __( &#x27;No post ID.&#x27;, &#x27;flawless&#x27; )
      );

    } else {

      $cfct_data = get_post_meta( $post_id, &#x27;_cfct_build_data&#x27;, true );

      $cfct_data[ &#x27;template&#x27; ][ &#x27;custom_class&#x27; ] = !empty( $new_class ) ? $new_class : &#x27;&#x27;;

      update_post_meta( $post_id, &#x27;_cfct_build_data&#x27;, $cfct_data );

      $response = array(
        &#x27;success&#x27; =&gt; &#x27;true&#x27;,
        &#x27;message&#x27; =&gt; __( &#x27;Custom build class saved.&#x27;, &#x27;flawless&#x27; )
      );

    }

    die( json_encode( $response ) );
  }


  /**
   * Hooks into HTML output for back-end row displsy
   *
   * @filter cfct-row-admin-html
   * @version 1.0
   */
  function cfct_row_admin_html( $html, $classname = false, $classes = false, $opts = false ) {

    //** Get just the unique class or row */
    $unique_class = implode( &#x27;.&#x27;, $classes );

    //** Load custom class if it exists from row $opts
    $current_setting = $opts[ &#x27;custom_class&#x27; ] ? $opts[ &#x27;custom_class&#x27; ] : &#x27;&#x27;;

    $html = str_replace( &#x27;&lt;a class=&quot;cfct-row-delete&quot; href=&quot;#&quot;&gt;Remove&lt;/a&gt;&#x27;, &#x27;&lt;a class=&quot;cfct-row-delete&quot; href=&quot;#&quot;&gt;Remove&lt;/a&gt;&lt;a class=&quot;cfct-add-row-class&quot; current_setting=&quot;&#x27;. $current_setting . &#x27;&quot; row_class=&quot;&#x27;. $unique_class . &#x27;&quot; title=&quot;Set, or change, custom row class.&quot; href=&quot;#&quot;&gt;Change Class&lt;/a&gt;&#x27;, $html );

    return $html;

  }


  /**
   * Saves custom row from AJAX post
   *
   * This may not be the most efficient function for this.
   *
   * @author potanin@UD
   * @version 1.0
   */
  function flawless_cb_save_tabbed_blocks() {

    $args = $_REQUEST[ &#x27;args&#x27; ];

    if( empty( $args ) || empty(  $args[ &#x27;post_id&#x27; ] ) ) {
      die( json_encode( array(
        &#x27;success&#x27; =&gt; &#x27;false&#x27;,
        &#x27;message&#x27; =&gt; __( &#x27;Failure, no post received.&#x27; , &#x27;flawless&#x27; )
      ) ) );
    }

    $cfct_data = get_post_meta( $args[ &#x27;post_id&#x27; ], &#x27;_cfct_build_data&#x27;, true );

    //** Blank out any old settings, they should all be updated */
    foreach( ( array ) $cfct_data[ &#x27;data&#x27; ][ &#x27;modules&#x27; ] as $module_id =&gt; $module_data ) {
      unset( $cfct_data[ &#x27;data&#x27; ][ &#x27;modules&#x27; ][ $module_id ][ &#x27;tabbed_block&#x27; ] );
    }

    /* Save data as is */
    $cfct_data[ &#x27;data&#x27; ][ &#x27;tabbed_blocks&#x27; ] = $args[ &#x27;blocks&#x27; ];

    foreach( ( array ) $args[ &#x27;blocks&#x27; ] as $block_key=&gt;$block_data ) {

      if( !empty( $block_data[ &#x27;tabbed_sections&#x27; ] ) ) {

        $block_id = $block_data[ &#x27;id&#x27; ];

        foreach( ( array ) $block_data[ &#x27;tabbed_sections&#x27; ] as $tab_key=&gt;$tabbed_sections ) {

          $sanitized_labels = array();

          foreach( ( array ) $tabbed_sections[ &#x27;tabs&#x27; ] as $tab_index =&gt; $tab_label ) {
            $sanitized_labels[ $tab_index ] = sanitize_title( $tab_label );
          }

          foreach( ( array ) $tabbed_sections[ &#x27;modules&#x27; ] as $tab_index =&gt; $modules_in_tab ) {

            foreach( ( array ) $modules_in_tab as $module_index_in_tab =&gt; $module_id ) {

              $cfct_data[ &#x27;data&#x27; ][ &#x27;modules&#x27; ][ $module_id ][ &#x27;tabbed_block&#x27; ][ &#x27;tabbed&#x27; ] = true;
              $cfct_data[ &#x27;data&#x27; ][ &#x27;modules&#x27; ][ $module_id ][ &#x27;tabbed_block&#x27; ][ &#x27;module_index_in_tab&#x27; ] = $module_index_in_tab;
              $cfct_data[ &#x27;data&#x27; ][ &#x27;modules&#x27; ][ $module_id ][ &#x27;tabbed_block&#x27; ][ &#x27;block_key&#x27; ] = $block_key;
              $cfct_data[ &#x27;data&#x27; ][ &#x27;modules&#x27; ][ $module_id ][ &#x27;tabbed_block&#x27; ][ &#x27;tab_key&#x27; ] = $tab_key;
              $cfct_data[ &#x27;data&#x27; ][ &#x27;modules&#x27; ][ $module_id ][ &#x27;tabbed_block&#x27; ][ &#x27;tab_index&#x27; ] = $tab_index;
              $cfct_data[ &#x27;data&#x27; ][ &#x27;modules&#x27; ][ $module_id ][ &#x27;tabbed_block&#x27; ][ &#x27;tab_sanitized_label&#x27; ] = $sanitized_labels[ $tab_index ];
              $cfct_data[ &#x27;data&#x27; ][ &#x27;modules&#x27; ][ $module_id ][ &#x27;tabbed_block&#x27; ][ &#x27;tab_label&#x27; ] = $tabbed_sections[ &#x27;tabs&#x27; ][ $tab_index ];

              if( $tab_index === 0 ) {
                $cfct_data[ &#x27;data&#x27; ][ &#x27;modules&#x27; ][ $module_id ][ &#x27;tabbed_block&#x27; ][ &#x27;first_tab&#x27; ] = true;
              }

              if( $module_index_in_tab === 0 ) {
                $cfct_data[ &#x27;data&#x27; ][ &#x27;modules&#x27; ][ $module_id ][ &#x27;tabbed_block&#x27; ][ &#x27;first_module&#x27; ] = true;
              }

              if( count( $modules_in_tab ) - 1 ===  $module_index_in_tab ) {
                $cfct_data[ &#x27;data&#x27; ][ &#x27;modules&#x27; ][ $module_id ][ &#x27;tabbed_block&#x27; ][ &#x27;last_module&#x27; ] = true;
              }

              if( count( $tabbed_sections[ &#x27;modules&#x27; ] ) - 1  === $tab_index ) {
                $cfct_data[ &#x27;data&#x27; ][ &#x27;modules&#x27; ][ $module_id ][ &#x27;tabbed_block&#x27; ][ &#x27;last_tab&#x27; ] = true;
              }

              /* First Module in First Tab */
              if( $cfct_data[ &#x27;data&#x27; ][ &#x27;modules&#x27; ][ $module_id ][ &#x27;tabbed_block&#x27; ][ &#x27;first_tab&#x27; ] &amp;&amp; $cfct_data[ &#x27;data&#x27; ][ &#x27;modules&#x27; ][ $module_id ][ &#x27;tabbed_block&#x27; ][ &#x27;first_module&#x27; ] ) {
                $cfct_data[ &#x27;data&#x27; ][ &#x27;modules&#x27; ][ $module_id ][ &#x27;tabbed_block&#x27; ][ &#x27;tab_labels&#x27; ] = $tabbed_sections[ &#x27;tabs&#x27; ];
                $cfct_data[ &#x27;data&#x27; ][ &#x27;modules&#x27; ][ $module_id ][ &#x27;tabbed_block&#x27; ][ &#x27;tab_sanitized_labels&#x27; ] = $sanitized_labels;
              }

            }

          }

        }

      }

    }

    //echo &#x27;&lt;pre&gt;&#x27; . print_r( $cfct_data , true ) . &#x27;&lt;/pre&gt;&#x27;;
    //echo &#x27;&lt;pre&gt;&#x27; . print_r( $args , true ) . &#x27;&lt;/pre&gt;&#x27;;
    //die();

    update_post_meta( $args[ &#x27;post_id&#x27; ], &#x27;_cfct_build_data&#x27;, $cfct_data );

    die( json_encode( array(
      &#x27;success&#x27; =&gt; &#x27;true&#x27;,
      &#x27;message&#x27; =&gt; __( &#x27;Block tabbed modules saved.&#x27;, &#x27;flawless&#x27; )
    ) ) );

  }


  /**
   * Called in cfct_build_module::html()
   *
   * Hooks into the content, within the wrapper, of a module.
   * We use this to get the $id_bases of all the modules in this request.
   *
   * @author potanin@UD
   */
  function cfct_module_display( $display, $id_base, $data ) {

    add_filter( &#x27;cfct-module-&#x27; . $id_base . &#x27;-html&#x27; , array(  &#x27;flawless_carrington&#x27;, &#x27;cfct_module_display_full&#x27; ), 10, 2 );

    return $display;

  }


  /**
   * Can return the module HTML, including the wrapper
   *
   * Hooks into the content, within the wrapper, of a module.
   * We use this to get the $id_bases of all the modules in this request.
   *
   * @author potanin@UD
   */
  function cfct_module_display_full( $default, $data ) {

    $html = array();

    if( $data[ &#x27;tabbed_block&#x27; ][ &#x27;first_tab&#x27; ] &amp;&amp; $data[ &#x27;tabbed_block&#x27; ][ &#x27;first_module&#x27; ] ) {
      //** This is done once when the first module in the first tab is being rendered */
      $html[] = &#x27;&lt;ul id=&quot;&#x27;.$data[ &#x27;module_id&#x27; ].&#x27;&quot; class=&quot;nav nav-tabs tabbed-module cfct-module&quot;&gt;&#x27;;

      foreach( ( array ) $data[ &#x27;tabbed_block&#x27; ][ &#x27;tab_labels&#x27; ] as $tab_index =&gt; $tab_label ) {

        $tab_classes = array( &#x27;tab&#x27; );

        if( $data[ &#x27;tabbed_block&#x27; ][ &#x27;first_tab&#x27; ] &amp;&amp; $data[ &#x27;tabbed_block&#x27; ][ &#x27;first_module&#x27; ] &amp;&amp; $tab_index === 0 ) {
          $tab_classes[] = &#x27;active&#x27;;
        }

        $html[] = &#x27;&lt;li class=&quot;&#x27; . implode( &#x27; &#x27;, $tab_classes ) . &#x27;&quot; tab_index=&quot;&#x27; . $tab_index . &#x27;&quot;  tab_target=&quot;&#x27; . &#x27;tm&#x27; . $data[ &#x27;tabbed_block&#x27; ][&#x27;block_key&#x27;] . &#x27;-&#x27; . $data[ &#x27;tabbed_block&#x27; ][&#x27;tab_key&#x27;]. &#x27;-&#x27; . $data[ &#x27;tabbed_block&#x27; ][ &#x27;tab_sanitized_labels&#x27; ][ $tab_index ] . &#x27;&quot;&gt;
        &lt;a href=&quot;#&#x27; . &#x27;tm&#x27; . $data[ &#x27;tabbed_block&#x27; ][&#x27;block_key&#x27;] . &#x27;-&#x27; . $data[ &#x27;tabbed_block&#x27; ][&#x27;tab_key&#x27;]. &#x27;-&#x27; . $data[ &#x27;tabbed_block&#x27; ][ &#x27;tab_sanitized_labels&#x27; ][ $tab_index ] . &#x27;&quot; data-toggle=&quot;tab&quot; &gt;&#x27; . $tab_label . &#x27;&lt;/a&gt;
        &lt;/li&gt;&#x27;;

      }

      $html[] = &#x27;&lt;/ul&gt;&lt;!-- .tabbed-module --&gt;&#x27;;

      //* Begin the wrapper for the tabs */
      $html[] = &#x27;&lt;div class=&quot;cfct-module tab-content tabbed-module&quot;&gt;&#x27;;

    }


    //** Done for the first module in every tab - setting up the openin wrapper */
    if( $data[ &#x27;tabbed_block&#x27; ][ &#x27;first_module&#x27; ] ) {

      $pane_class = array( &#x27;tab-pane&#x27; );

      if( $data[ &#x27;tabbed_block&#x27; ][ &#x27;first_tab&#x27; ] ) {
        $pane_class[] = &#x27;active&#x27;;
      }

    $html[] = &#x27;&lt;div id=&quot;&#x27; . &#x27;tm&#x27; . $data[ &#x27;tabbed_block&#x27; ][&#x27;block_key&#x27;] . &#x27;-&#x27; . $data[ &#x27;tabbed_block&#x27; ][&#x27;tab_key&#x27;]. &#x27;-&#x27; .$data[ &#x27;tabbed_block&#x27; ][ &#x27;tab_sanitized_label&#x27; ] . &#x27;&quot; class=&quot;&#x27; . implode( &#x27; &#x27;, $pane_class )  . &#x27;&quot; tab_index=&quot;&#x27; . $data[ &#x27;tabbed_block&#x27; ][ &#x27;tab_index&#x27; ] . &#x27;&quot; module_index_in_tab=&quot;&#x27; . $data[ &#x27;tabbed_block&#x27; ][ &#x27;module_index_in_tab&#x27; ] . &#x27;&quot;&gt;&#x27;;

    }

    //** Return the actual module content - ran on every iteration */
    $html[] = $default;

    //** Ran for every last module in each tab to close the tab element */
    if( $data[ &#x27;tabbed_block&#x27; ][ &#x27;last_module&#x27; ] ) {
      $html[] = &#x27;&lt;/div&gt;&lt;!-- .tab-pane --&gt;&#x27;;
    }

    //** Ran after the final module in the last tab, to close the entire element */
    if( $data[ &#x27;tabbed_block&#x27; ][ &#x27;last_tab&#x27; ] &amp;&amp; $data[ &#x27;tabbed_block&#x27; ][ &#x27;last_module&#x27; ] ) {
      $html[] = &#x27;&lt;/div&gt;&lt;!-- .tabbed-module --&gt;&#x27;;
    }

    //die( &#x27;&lt;pre&gt;&#x27; . print_r( $html , true ) . &#x27;&lt;/pre&gt;&#x27; );

    return implode( &quot;\n&quot;, ( array ) $html );

  }


  /**
   * Loads custom row class, if it exists
   *
   * @todo Add row &quot;first&quot; and &quot;last&quot; classes based on current row.
   * @filter cfct-generated-row-classes
   * @version 1.0
   */
  function cfct_generated_row_classes( $nothing, $module_types, $that, $opts ) {
    global $post, $cfct_build;

    if( is_admin() ) {
      return $nothing;
    }

    $_cfct_build_data = get_post_meta( $post-&gt;ID, &#x27;_cfct_build_data&#x27;, true );

    //$_rows = count( $_cfct_build_data[ &#x27;template&#x27; ][ &#x27;rows&#x27; ] );

    $custom_class[] = &#x27;row-fluid&#x27;;

    $custom_class[] = !empty( $opts[ &#x27;custom_class&#x27; ] ) ? $opts[ &#x27;custom_class&#x27; ] : &#x27;default-row-class&#x27;;

    return $custom_class;

  }


  /**
   * Front-end row output
   *
   * Not used, only here for future reference.
   * @author potanin@UD
   * @version 1.0
   */
  function cfct_row_html( $html = false, $classname = false, $classes = false, $opts = false ) {

    return $html;
  }


  /**
   *  Adds a class to the body of pages using CB
   *
   * @author potanin@UD
   */
  function body_class( $classes, $class ) {
    global $post;

    if( !$_cfct_build_data = get_post_meta( $post-&gt;ID, &#x27;_cfct_build_data&#x27;, true ) ) {
      $classes[] = &#x27;non_carrington_layout&#x27;;
    }

    if( $_cfct_build_data[ &#x27;active_state&#x27; ] == &#x27;build&#x27; ) {
      $classes[] = &#x27;carrington_layout&#x27;;
    } else {
      $classes[] = &#x27;non_carrington_layout&#x27;;
    }

    $classes = array_unique( $classes );

    return $classes;

  }


  /**
   *  Adds a class to the flawless_module_class() classes
   *
   * @author potanin@UD
   */
  function module_class( $classes ) {
    global $post, $cfct_build;

    //** If not a carrinton build layout, do nothing */
    if( !$cfct_build-&gt;can_do_build() ) {
      return $classes;
    }

    //** If CB is used, we must remove cfct-module */
    $classes = array_flip( (array) $classes );
    unset( $classes[ &#x27;cfct-module&#x27; ] );
    $classes = array_flip( (array) $classes );

    return array_unique( (array) $classes );

  }


  /**
   * Tells CB where it is located ( always in parent theme )
   *
   * @author potanin@UD
   * @version 1.0
   */
  function cfct_build_loc( $location ) {

    $location[ &#x27;loc&#x27; ] = &#x27;theme&#x27;;
    $location[ &#x27;path&#x27; ] = TEMPLATEPATH . &#x27;/functions&#x27;;
    $location[ &#x27;url&#x27; ] = get_bloginfo( &#x27;template_url&#x27; ) . &#x27;/functions&#x27;;

    return $location;

  }


  /**
   * Adds Flawless Custom Post Types to Carrington editor, and removes defaults if setting exists in Flawless
   *
   * @author potanin@UD
   * @version 1.0
   */
  function add_custom_post_types( $types ) {
    global $flawless;

    //** Should never happen, but return default settings if no configuration exists */
    if( !is_array( $flawless[ &#x27;post_types&#x27; ] ) ) {
      return $types;
    }

    //** Cycle through Flawless settings */
    foreach( $flawless[ &#x27;post_types&#x27; ] as $type =&gt; $data ) {
      if( $data[ &#x27;use_carrington&#x27; ] == &#x27;true&#x27; ) {
        $types[] = $type;

      } elseif( $data[ &#x27;use_carrington&#x27; ] == &#x27;false&#x27; ) {

        //** Disable only if specifically disabled by Flawless. */
        unset( $types[array_search( $type, $types )] );

      } else {
        //** Do nothing if there is no explicit setting for this type */
      }
    }

    return $types;

  }


  /**
   * Adds option to enable Carrington Editor for the post tpe
   *
   * If post type is a page, and not setting exists, we enable editing since it is the default setting.
   *
   * @author potanin@UD
   * @version 1.0
   */
  function flawless_post_types_advanced_options( $args ) {

    extract( $args );

    if( $type == &#x27;page&#x27; &amp;&amp; !isset( $data[ &#x27;use_carrington&#x27; ] ) ) {
      $data[ &#x27;use_carrington&#x27; ] = &#x27;true&#x27;;
    }

  ?&gt;
    &lt;li class=&quot;flawless_advanced_option&quot;&gt;
      &lt;input type=&quot;hidden&quot; name=&quot;flawless_settings[post_types][&lt;?php echo $type; ?&gt;][use_carrington]&quot; value=&quot;false&quot; /&gt;
      &lt;input id=&quot;&lt;?php echo $type; ?&gt;_use_carrington&quot; type=&quot;checkbox&quot; &lt;?php checked( &#x27;true&#x27;, $data[ &#x27;use_carrington&#x27; ] ); ?&gt; name=&quot;flawless_settings[post_types][&lt;?php echo $type; ?&gt;][use_carrington]&quot; value=&quot;true&quot; /&gt;
      &lt;label for=&quot;&lt;?php echo $type; ?&gt;_use_carrington&quot;&gt;&lt;?php _e( &#x27;Use Carrington Build for editing.&#x27;,&#x27;flawless&#x27; ) ?&gt;&lt;/label&gt;
    &lt;/li&gt;
  &lt;?php
  }


  /**
   * Loads extra options into CB Settings dropdown
   *
   * @author potanin@UD
   * @version 1.0
   */
  function cfct_build_page_options() {
    global $post;

    $cfct_data = get_post_meta( $post-&gt;ID, &#x27;_cfct_build_data&#x27;, true );

    $current_setting = !empty( $cfct_data[ &#x27;template&#x27; ][ &#x27;custom_class&#x27; ] ) ? $cfct_data[ &#x27;template&#x27; ][ &#x27;custom_class&#x27; ] : &#x27;&#x27;;

    $options[] = &#x27;&lt;li&gt;&lt;a id=&quot;cfct-set-build-class&quot; href=&quot;#cfct-set-build-class&quot; current_setting=&quot;&#x27;. $current_setting . &#x27;&quot; &gt;Set Build Class&lt;/a&gt;&lt;/li&gt;&#x27;;
    $options[] = &#x27;&lt;li&gt;&lt;a id=&quot;cfct-copy-build-data&quot; href=&quot;#cfct-copy-build&quot;&gt;Copy Layout&lt;/a&gt;&lt;/li&gt;&#x27;;
    $options[] = &#x27;&lt;li&gt;&lt;a id=&quot;cfct-paste-build-data&quot; href=&quot;#cfct-paste-build&quot;&gt;Paste Layout&lt;/a&gt;&lt;/li&gt;&#x27;;

    return implode( &#x27;&#x27;, $options );

  }


  /**
   * {description missing}
   *
   * @author potanin@UD
   * @version 1.0
   */
  function get_page_build( $post_id ) {

    $content = get_post_meta( $post_id, &#x27;_cfct_build_data&#x27;, true );

    $results[ &#x27;success&#x27; ] = &#x27;true&#x27;;
    $results[ &#x27;content&#x27; ] = base64_encode( serialize( $content ) );

    return json_encode( $results );
  }


  /**
   * {description missing}
   *
   * @author potanin@UD
   * @version 1.0
   */
  function insert_page_build( $post_id, $post_data ) {
    global $wpdb;

    $post_data = stripslashes( $post_data );

    $post_data = unserialize( base64_decode( $post_data ) );

    if( update_post_meta( $post_id, &#x27;_cfct_build_data&#x27;, $post_data ) ) {
      $results[ &#x27;success&#x27; ] = &#x27;true&#x27;;
    }

    return json_encode( $results );
  }


}


$flawless_carrington = new flawless_carrington();

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
